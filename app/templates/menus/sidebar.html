{# ------------------------------------------------------------------------------
  File: sidebar.html | Purpose: Left sidebar navigation with collapsible functionality
  Imports:
    - navigation.html: For shared navigation items
  Features:
    - Collapsible sidebar
    - Same navigation items as navbar
    - Toggle button for expanding/collapsing
------------------------------------------------------------------------------ #}

{%- set scriptName = 'sidebar.html' -%}
{% from 'macros/navigation.html' import get_endpoint, is_active, get_url %}
{% include 'menus/nav_items.html' %}

<div id="sidebar" class="sidebar">
  <script type="module">
    import log from '{{ url_for('static', filename='js/core/logger.js') }}';
    log("info", "{{ scriptName }}", "init", "ðŸš€ Sidebar component loaded");
  </script>

  <div class="sidebar-header">
    <a class="sidebar-brand d-flex align-items-center" href="/">
      <div class="brand-icon-container me-2"><i class="fas fa-building"></i></div>
      <span class="brand-text">CRM Dashboard</span>
    </a>
    <button id="sidebarToggleBtn" class="btn btn-link sidebar-toggle d-lg-none">
      <i class="fas fa-times"></i>
    </button>
  </div>

  <div class="sidebar-content">
    <ul class="sidebar-nav">
      {% for item in nav_items %}
        {% set endpoint = get_endpoint(item) %}
        {% set is_active_item = is_active(item) %}
        {% set item_url = get_url(item) %}

        <li class="sidebar-item {% if is_active_item %}active{% endif %}">
          <a href="{{ item_url }}" class="sidebar-link" {% if is_active_item %}aria-current="page"{% endif %}>
            <i class="fas {{ item.icon }} sidebar-icon"></i>
            <span class="sidebar-text">{{ item.display_name }}</span>
            {% if is_active_item %}<span class="active-indicator"></span>{% endif %}
          </a>
        </li>
        <script type="module">
          import log from '{{ url_for('static', filename='js/core/logger.js') }}';
          log("debug", "{{ scriptName }}", "sidebar_item", "Rendered sidebar item: {{ item.name }}");
        </script>
      {% endfor %}
    </ul>
  </div>

  <div class="sidebar-footer">
    <button class="btn btn-sidebar-collapse" id="sidebarCollapseBtn">
      <i class="fas fa-chevron-left"></i>
    </button>
  </div>
</div>

<div id="sidebar-overlay"></div>

<script type="module">
  import log from '{{ url_for('static', filename='js/core/logger.js') }}';

  document.addEventListener('DOMContentLoaded', () => {
    log("info", "{{ scriptName }}", "dom", "Setting up sidebar interactions");

    const sidebar = document.getElementById('sidebar');
    const sidebarCollapseBtn = document.getElementById('sidebarCollapseBtn');
    const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    const body = document.body;

    // Check if sidebar is collapsed in localStorage
    const isSidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
    if (isSidebarCollapsed) {
      body.classList.add('sidebar-collapsed');
      log("debug", "{{ scriptName }}", "state", "Sidebar initialized as collapsed from storage");
    }

    // Collapse button (desktop)
    sidebarCollapseBtn.addEventListener('click', () => {
      body.classList.toggle('sidebar-collapsed');
      const isNowCollapsed = body.classList.contains('sidebar-collapsed');
      localStorage.setItem('sidebarCollapsed', isNowCollapsed);
      log("info", "{{ scriptName }}", "action", `Sidebar ${isNowCollapsed ? 'collapsed' : 'expanded'}`);
    });

    // Toggle button and overlay (mobile)
    sidebarToggleBtn.addEventListener('click', () => {
      body.classList.remove('sidebar-open');
      log("info", "{{ scriptName }}", "action", "Sidebar closed on mobile");
    });

    sidebarOverlay.addEventListener('click', () => {
      body.classList.remove('sidebar-open');
      log("info", "{{ scriptName }}", "action", "Sidebar closed via overlay");
    });

    // Create the mobile toggle button for the fixed navbar
    const mobileToggle = document.createElement('button');
    mobileToggle.className = 'btn btn-icon sidebar-mobile-toggle d-lg-none';
    mobileToggle.innerHTML = '<i class="fas fa-bars"></i>';
    mobileToggle.addEventListener('click', () => {
      body.classList.add('sidebar-open');
      log("info", "{{ scriptName }}", "action", "Sidebar opened on mobile");
    });

    // Insert the mobile toggle button into the navbar
    const navbar = document.querySelector('.navbar-brand');
    if (navbar) {
      navbar.parentNode.insertBefore(mobileToggle, navbar);
      log("debug", "{{ scriptName }}", "render", "Mobile toggle button added to navbar");
    }

    log("info", "{{ scriptName }}", "final", "Sidebar functionality initialized");
  });
</script>

<style>
  /* Sidebar Base Styles */
  .sidebar {
    position: fixed;
    top: 0;
    left: 0;
    height: 100vh;
    width: 250px;
    background-color: #fff;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    display: flex;
    flex-direction: column;
    z-index: 1040;
    transition: all 0.3s ease;
  }

  .sidebar-header {
    padding: 1rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid #eee;
  }

  .sidebar-content {
    flex: 1;
    overflow-y: auto;
    padding: 1rem 0;
  }

  .sidebar-footer {
    padding: 1rem;
    display: flex;
    justify-content: flex-end;
    border-top: 1px solid #eee;
  }

  /* Sidebar Navigation */
  .sidebar-nav {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .sidebar-item {
    position: relative;
  }

  .sidebar-link {
    display: flex;
    align-items: center;
    padding: 0.75rem 1.5rem;
    color: #495057;
    text-decoration: none;
    transition: all 0.2s ease;
  }

  .sidebar-link:hover {
    background-color: rgba(0, 0, 0, 0.05);
    color: #000;
  }

  .sidebar-item.active .sidebar-link {
    background-color: rgba(13, 110, 253, 0.1);
    color: #0d6efd;
    font-weight: 500;
  }

  .sidebar-icon {
    width: 20px;
    text-align: center;
    margin-right: 10px;
  }

  .active-indicator {
    position: absolute;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    width: 3px;
    height: 20px;
    background-color: #0d6efd;
    border-radius: 0 3px 3px 0;
  }

  /* Sidebar Toggle Button */
  .btn-sidebar-collapse {
    background: transparent;
    border: none;
    color: #495057;
    padding: 0.375rem;
    border-radius: 50%;
    line-height: 1;
  }

  .btn-sidebar-collapse:hover {
    background-color: rgba(0, 0, 0, 0.05);
    color: #000;
  }

  /* Sidebar Collapsed State */
  .sidebar-collapsed .sidebar {
    width: 60px;
  }

  .sidebar-collapsed .sidebar-text,
  .sidebar-collapsed .brand-text {
    display: none;
  }

  .sidebar-collapsed .sidebar-link {
    justify-content: center;
    padding: 0.75rem;
  }

  .sidebar-collapsed .sidebar-icon {
    margin-right: 0;
    font-size: 1.1rem;
  }

  .sidebar-collapsed .btn-sidebar-collapse i {
    transform: rotate(180deg);
  }

  /* Mobile Sidebar */
  .sidebar-mobile-toggle {
    display: none;
  }

  #sidebar-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    z-index: 1030;
    display: none;
  }

  /* Responsive Adjustments */
  @media (max-width: 991.98px) {
    .sidebar {
      transform: translateX(-100%);
    }

    .sidebar-mobile-toggle {
      display: block;
      margin-right: 10px;
    }

    .sidebar-open .sidebar {
      transform: translateX(0);
    }

    .sidebar-open #sidebar-overlay {
      display: block;
    }

    /* Adjust main content spacing */
    .sidebar-collapsed .main-content {
      margin-left: 0;
    }
  }

  /* Dark Mode Support */
  [data-theme="dark"] .sidebar {
    background-color: #212529;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
    border-right: 1px solid #343a40;
  }

  [data-theme="dark"] .sidebar-header,
  [data-theme="dark"] .sidebar-footer {
    border-color: #343a40;
  }

  [data-theme="dark"] .sidebar-link {
    color: #e9ecef;
  }

  [data-theme="dark"] .sidebar-link:hover {
    background-color: rgba(255, 255, 255, 0.1);
    color: #fff;
  }

  [data-theme="dark"] .sidebar-item.active .sidebar-link {
    background-color: rgba(13, 110, 253, 0.2);
  }

  [data-theme="dark"] .btn-sidebar-collapse {
    color: #e9ecef;
  }

  [data-theme="dark"] .btn-sidebar-collapse:hover {
    background-color: rgba(255, 255, 255, 0.1);
    color: #fff;
  }
</style>