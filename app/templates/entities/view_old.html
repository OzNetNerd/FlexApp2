{% extends 'layouts/base_view.html' %}
{% import 'macros/layout.html' as layout %}
{% import 'macros/forms.html' as forms %}
{% import 'macros/entity.html' as entity %}

{% block form_content %}
  {% if ui_config %}
    {# Organize fields by tabs #}
    {% set tabs_list = [] %}
    {% set tab_names = [] %}  {# Track used tab names #}

    {# First pass - group fields by tab #}
    {% for section_name, fields in ui_config.items() %}
      {% for field in fields %}
        {% set tab_name = field.tab|default('General') %}
        {% set tab_icon = field.tab_icon|default('info-circle') %}

        {# Only add tab if name not already used #}
        {% if tab_name not in tab_names %}
          {% set _ = tab_names.append(tab_name) %}
          {% set _ = tabs_list.append({
            'name': tab_name,
            'id': tab_name|lower|replace(' ', '-'),
            'icon': tab_icon,
            'active': tab_names|length == 1,  {# Set first tab as active #}
            'sections': {}
          }) %}
        {% endif %}

        {# Find the tab index #}
        {% set tab_index = tab_names.index(tab_name) %}

        {# Add to section within tab #}
        {% if section_name not in tabs_list[tab_index].sections %}
          {% set _ = tabs_list[tab_index].sections.update({section_name: []}) %}
        {% endif %}

        {% set _ = tabs_list[tab_index].sections[section_name].append(field) %}
      {% endfor %}
    {% endfor %}

    {# Render tabs navigation #}
    {{ layout.tabs_navigation(tabs_list) }}

    {# Render tab content #}
    {% call layout.tabs_content() %}
      {% for tab in tabs_list %}
        {% call layout.tab_pane(tab.id, tab.active|default(loop.first)) %}
          {% for section_name, fields in tab.sections.items() %}
            {% call layout.section(section_name) %}
              {{ forms.render_fields_row(fields, read_only=read_only) }}
            {% endcall %}
          {% endfor %}
        {% endcall %}
      {% endfor %}
    {% endcall %}

  {% else %}
    <div class="alert alert-danger">UI config missing</div>
  {% endif %}
{% endblock %}