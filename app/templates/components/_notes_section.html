<!-- START TEMPLATE: _notes_section.html -->
{% import 'base/macros/render_form_fields.html' as field_macros with context %}

<div class="card shadow-sm border-0 mb-4">
  <div class="card-header bg-white d-flex justify-content-between align-items-center">
    <h5 class="h6 text-primary fw-semibold mb-0">Notes</h5>
    <div class="dropdown">
      <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="notesFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
        <i class="fas fa-filter me-1"></i> Filter
      </button>
      <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="notesFilterDropdown">
        <li><a class="dropdown-item note-filter" href="#" data-days="7">Last 7 days</a></li>
        <li><a class="dropdown-item note-filter" href="#" data-days="30">Last 30 days</a></li>
        <li><a class="dropdown-item note-filter" href="#" data-days="90">Last 90 days</a></li>
        <li><hr class="dropdown-divider"></li>
        <li>
          <form class="px-3 py-2" id="notesSearchForm">
            <div class="input-group input-group-sm">
              <input type="text" class="form-control" id="noteSearchInput" placeholder="Search...">
              <button class="btn btn-outline-primary" type="submit">
                <i class="fas fa-search"></i>
              </button>
            </div>
          </form>
        </li>
      </ul>
    </div>
  </div>

  <div class="card-body">
    <div id="notesList" class="mb-3">
      <!-- Notes will be loaded here via AJAX -->
      <div class="text-center py-3 text-muted" id="notesLoading">
        <div class="spinner-border spinner-border-sm me-2" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        Loading notes...
      </div>
    </div>

    <!-- Removed conditional to always show the form -->
    <form id="newNoteForm" class="border-top pt-3">
      <div class="row g-3">
        {{ field_macros.render_field({
            "entry_name": "content",
            "label": "Add Note",
            "type": "textarea",
            "value": "",
            "required": true,
            "rows": 3,
            "options": []
         }, read_only=false) }}

        <!-- Hidden fields for notable entity type and ID -->
        <input type="hidden" id="notable_type" name="notable_type" value="{{ entity.__class__.__name__ }}">
        <input type="hidden" id="notable_id" name="notable_id" value="{{ entity.id }}">
        <input type="hidden" id="user_id" name="user_id" value="{{ current_user.id }}">

        <!-- Add user information fields -->
        <input type="hidden" id="username" name="username" value="{{ current_user.username|default(current_user.name|default(current_user.email|default(''))) }}">

        <!-- Add CSRF token if your application uses it -->
        {% if csrf_token is defined %}
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        {% endif %}
      </div>

      <div class="d-flex justify-content-end mt-3">
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-plus me-1"></i> Add Note
        </button>
      </div>
    </form>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Variables
    const notableType = '{{ entity.__class__.__name__ }}';
    const notableId = '{{ entity.id }}';
    const notesList = document.getElementById('notesList');
    const notesLoading = document.getElementById('notesLoading');
    const statusMessage = document.createElement('div');
    statusMessage.className = 'alert mt-3 d-none';

    // Add status message container after the form
    document.getElementById('newNoteForm').insertAdjacentElement('afterend', statusMessage);

    // Initial notes load
    loadNotes();

    // Load notes with optional filters
    function loadNotes(filters = {}) {
      notesLoading.style.display = 'block';

      // Build query string
      let queryParams = new URLSearchParams();
      queryParams.append('notable_type', notableType);
      queryParams.append('notable_id', notableId);

      // Add additional filters
      for (const [key, value] of Object.entries(filters)) {
        queryParams.append(key, value);
      }

      // Fetch notes
      fetch(`/api/notes/query?${queryParams.toString()}`)
        .then(response => {
          if (!response.ok) {
            // Try to get error details if available
            return response.json().then(errorData => {
              throw new Error(`API responded with status: ${response.status}: ${JSON.stringify(errorData)}`);
            }).catch(e => {
              throw new Error(`API responded with status: ${response.status}`);
            });
          }
          return response.json();
        })
        .then(data => {
          notesLoading.style.display = 'none';
          renderNotes(data.data);
        })
        .catch(error => {
          notesLoading.style.display = 'none';
          notesList.innerHTML = `<div class="alert alert-danger">Error loading notes: ${error.message}</div>`;
          console.error('Notes loading error:', error);
        });
    }

    // Render notes
    function renderNotes(notes) {
      if (!notes || notes.length === 0) {
        notesList.innerHTML = '<div class="text-center py-3 text-muted">No notes found</div>';
        return;
      }

      let html = '';
      notes.forEach(note => {
        const date = new Date(note.created_at).toLocaleString();

        // Debug log to see what user data we're getting
        console.log('Note user data:', note.user, 'user_id:', note.user_id);

        // Use current username when displaying user's own notes
        let username = 'Unknown User';
        const currentUserId = '{{ current_user.id }}';

        if (note.user_id && note.user_id.toString() === currentUserId) {
          username = '{{ current_user.username|default(current_user.name|default(current_user.email|default("You"))) }}';
        }
        // Otherwise check API data sources
        else if (note.user) {
          if (typeof note.user === 'object') {
            username = note.user.username || note.user.name || note.user.email || 'Unknown User';
          } else if (typeof note.user === 'string') {
            username = note.user;
          }
        } else if (note.username) {
          username = note.username;
        }

        html += `
          <div class="note-item mb-3 p-3 border rounded">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <strong>${username}</strong>
              <small class="text-muted">${date}</small>
            </div>
            <div class="note-content">
              ${note.processed_content || note.content}
            </div>
          </div>
        `;
      });

      notesList.innerHTML = html;
    }

    // Filter by days
    document.querySelectorAll('.note-filter').forEach(filter => {
      filter.addEventListener('click', function(e) {
        e.preventDefault();
        const days = this.dataset.days;
        loadNotes({days: days});
      });
    });

    // Search form
    const searchForm = document.getElementById('notesSearchForm');
    if (searchForm) {
      searchForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const searchTerm = document.getElementById('noteSearchInput').value.trim();
        if (searchTerm) {
          loadNotes({q: searchTerm});
        }
      });
    }

    // Show status message
    function showStatus(message, type = 'success') {
      statusMessage.className = `alert alert-${type} mt-3`;
      statusMessage.textContent = message;
      statusMessage.classList.remove('d-none');

      // Auto-hide after 5 seconds
      setTimeout(() => {
        statusMessage.classList.add('d-none');
      }, 5000);
    }

    // Add new note with improved feedback
    const newNoteForm = document.getElementById('newNoteForm');
    if (newNoteForm) {
      newNoteForm.addEventListener('submit', function(e) {
        e.preventDefault();

        // Basic validation
        const contentField = document.getElementById('content');
        if (!contentField || !contentField.value.trim()) {
          showStatus('Please enter a note.', 'danger');
          return;
        }

        // Disable submit button during submission
        const submitBtn = newNoteForm.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span> Submitting...';

        const formData = new FormData(newNoteForm);
        const noteData = Object.fromEntries(formData.entries());

        // Only keep the expected fields to avoid 500 errors
        const cleanedData = {
          content: noteData.content,
          notable_type: noteData.notable_type,
          notable_id: noteData.notable_id,
          user_id: noteData.user_id
        };

        // Debug log
        console.log('Submitting note with data:', cleanedData);

        fetch('/api/notes/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(cleanedData)
        })
        .then(response => {
          if (!response.ok) {
            throw new Error(`API responded with status: ${response.status}`);
          }
          return response.json();
        })
        .then(data => {
          if (data.error) {
            throw new Error(data.error.message);
          }
          // Clear form and reload notes
          newNoteForm.reset();
          loadNotes();
          showStatus('Note added successfully!');
        })
        .catch(error => {
          showStatus(`Error adding note: ${error.message}`, 'danger');
          console.error('Error adding note:', error);
        })
        .finally(() => {
          // Re-enable submit button
          submitBtn.disabled = false;
          submitBtn.innerHTML = '<i class="fas fa-plus me-1"></i> Add Note';
        });
      });
    }
  });
</script>
<!-- END TEMPLATE: _notes_section.html -->