{# macros/form.html #}

{# Keep all existing macros #}
{% macro render_field(entry, read_only=False) %}
  <div class="col-md-6 mb-3">
    {% if read_only %}
      <div class="note-item mb-3 p-3 border rounded">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <strong>{{ entry.label }}</strong>
        </div>
        <div class="note-content">
          {% if entry.type == 'checkbox' %}
            <p><i class="fas fa-{{ 'check' if entry.value else 'times' }}"></i> {{ 'Yes' if entry.value else 'No' }}</p>
          {% elif entry.type == 'select' and entry.options %}
            {% for option in entry.options %}
              {% if option is string and option == entry.value %}
                <p>{{ option }}</p>
              {% elif option is mapping %}
                {% if entry.value == option.value %}
                  <p>{{ option.text or option.label }}</p>
                {% endif %}
              {% endif %}
            {% endfor %}
          {% elif entry.type == 'date' %}
            <p>{{ entry.value.strftime('%Y-%m-%d') if entry.value else '' }}</p>
          {% else %}
            {% if entry.value is not none %}
              <p>{{ entry.value }}</p>
            {% endif %}
          {% endif %}
        </div>
      </div>
    {% else %}
      <label for="{{ entry.name }}" class="form-label fw-semibold">{{ entry.label }}</label>
      {% if entry.type == 'textarea' %}
        <textarea class="form-control" id="{{ entry.name }}" name="{{ entry.name }}"
                  {% if entry.required %}required{% endif %}>{{ entry.value or '' }}</textarea>
      {% elif entry.type == 'select' and entry.options %}
        <select class="form-select" id="{{ entry.name }}" name="{{ entry.name }}"
                {% if entry.required %}required{% endif %}>
          <option value="">-- Select {{ entry.label }} --</option>
          {% for option in entry.options %}
            {% if option is string %}
              <option value="{{ option }}" {% if entry.value == option %}selected{% endif %}>
                {{ option }}
              </option>
            {% elif option is mapping %}
              <option value="{{ option.value }}" {% if entry.value == option.value %}selected{% endif %}>
                {{ option.text or option.label }}
              </option>
            {% endif %}
          {% endfor %}
        </select>
      {% elif entry.type == 'checkbox' %}
        <div class="form-check">
          <input type="checkbox" class="form-check-input" id="{{ entry.name }}" name="{{ entry.name }}"
                 {% if entry.value %}checked{% endif %}>
          <label class="form-check-label" for="{{ entry.name }}">{{ entry.label }}</label>
        </div>
      {% elif entry.type == 'date' %}
        <input type="date" class="form-control" id="{{ entry.name }}" name="{{ entry.name }}"
               value="{{ entry.value }}" {% if entry.required %}required{% endif %}>
      {% elif entry.type == 'number' %}
        <input type="number" class="form-control" id="{{ entry.name }}" name="{{ entry.name }}"
               value="{{ entry.value or '' }}" {% if entry.required %}required{% endif %}>
      {% elif entry.type == 'readonly' %}
        <div class="form-control-plaintext">{{ entry.value }}</div>
      {% else %}
        <input type="text" class="form-control" id="{{ entry.name }}" name="{{ entry.name }}"
               value="{{ entry.value or '' }}" {% if entry.required %}required{% endif %}>
      {% endif %}

      {% if entry.help_text %}
        <div class="form-text text-muted">{{ entry.help_text }}</div>
      {% endif %}
    {% endif %}
  </div>
{% endmacro %}

{# Add a debug version of render_simple_form that displays its context #}
{% macro render_simple_form(ui_config, model_name="", error_message="", read_only=False) %}
  {% if ui_config %}
    {% for section_name, fields in ui_config.items() %}
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="mb-0">{{ section_name }}</h5>
        </div>
        <div class="card-body">
          <div class="row">
            {% for field in fields %}
              {{ render_field(field, read_only=read_only) }}
            {% endfor %}
          </div>
        </div>
      </div>
    {% endfor %}
  {% else %}
    <div class="alert alert-danger">
      <p>UI Config is missing or undefined. Cannot render form.</p>
    </div>
  {% endif %}

  {% if error_message %}
    <div class="alert alert-danger">
      <p>Error: {{ error_message }}</p>
    </div>
  {% endif %}
{% endmacro %}

{# Keep existing macros #}
{% macro render_tabbed_form(ui, model_name="", error_message="", read_only=False) %}
  <div class="tab-content">
    {% for tab in ui %}
      <div class="tab-pane fade {% if loop.first %}show active{% endif %}"
           id="tab-{{ tab.tab_name | lower | replace(' ', '-') }}"
           role="tabpanel"
           aria-labelledby="tab-{{ tab.tab_name | lower | replace(' ', '-') }}-tab">
        {% for section in tab.sections %}
          <h5 class="mt-3">{{ section.section_name }}</h5>
          <div class="row">
            {% for entry in section.entries %}
              {{ render_field(entry, read_only=read_only) }}
            {% endfor %}
          </div>
        {% endfor %}
      </div>
    {% endfor %}
  </div>

  <script type="module" src="{{ url_for('static', filename='js/main.js') }}"></script>

  {% if error_message %}
    <script type="module">
      import { showToast } from "/static/js/toasts.js";
      document.addEventListener('DOMContentLoaded', () => {
        const message = {{ ("Error creating " ~ model_name ~ ": " ~ error_message) | tojson }};
        showToast(message, "error");
      });
    </script>
  {% endif %}
{% endmacro %}

{% macro render_pill_navigation(tabs) %}
  <ul class="nav nav-pills mb-3" id="pills-tab" role="tablist">
    {% for tab in tabs %}
      <li class="nav-item" role="presentation">
        <button class="nav-link {% if loop.first %}active{% endif %}"
                id="tab-{{ tab.tab_name | lower | replace(' ', '-') }}-tab"
                data-bs-toggle="pill"
                data-bs-target="#tab-{{ tab.tab_name | lower | replace(' ', '-') }}"
                type="button"
                role="tab"
                aria-controls="tab-{{ tab.tab_name | lower | replace(' ', '-') }}"
                aria-selected="{% if loop.first %}true{% else %}false{% endif %}">
          {% if tab.icon %}
            <i class="fas fa-{{ tab.icon }} me-1"></i>
          {% endif %}
          {{ tab.tab_name }}
        </button>
      </li>
    {% endfor %}
  </ul>
{% endmacro %}