{# macros/forms.html - Form components and fields #}

{% macro render_field(entry, read_only=false, column_class="col-md-6") %}
  <div class="{{ column_class }} mb-3">
    {% if read_only %}
      <div class="note-item mb-3 p-3 border rounded">
        <div class="d-flex justify-content-between align-items-start mb-2">
          <strong>{{ entry.label }}</strong>
        </div>
        <div class="note-content">
          {% if entry.type == 'checkbox' %}
            <p><i class="fas fa-{{ 'check' if entry.value else 'times' }}"></i> {{ 'Yes' if entry.value else 'No' }}</p>
          {% elif entry.type == 'select' and entry.options %}
            {% for option in entry.options %}
              {% if option is string and option == entry.value %}
                <p>{{ option }}</p>
              {% elif option is mapping %}
                {% if entry.value == option.value %}
                  <p>{{ option.text or option.label }}</p>
                {% endif %}
              {% endif %}
            {% endfor %}
          {% elif entry.type == 'date' %}
            <p>{{ entry.value.strftime('%Y-%m-%d') if entry.value else '' }}</p>
          {% else %}
            {% if entry.value is not none %}
              <p>{{ entry.value }}</p>
            {% endif %}
          {% endif %}
        </div>
      </div>
    {% else %}
      {% set field_id = entry.id | default(entry.name | default(entry.entry_name)) %}
      <label for="{{ field_id }}" class="form-label fw-semibold">{{ entry.label }}</label>

      {% if entry.type == 'textarea' %}
        <textarea class="form-control" id="{{ field_id }}" name="{{ field_id }}"
                  {% if entry.required %}required{% endif %}>{{ entry.value or '' }}</textarea>
      {% elif entry.type == 'select' and entry.options %}
        <select class="form-select" id="{{ field_id }}" name="{{ field_id }}"
                {% if entry.required %}required{% endif %}>
          <option value="">-- Select {{ entry.label }} --</option>
          {% for option in entry.options %}
            {% if option is string %}
              <option value="{{ option }}" {% if entry.value == option %}selected{% endif %}>
                {{ option }}
              </option>
            {% elif option is mapping %}
              <option value="{{ option.value }}" {% if entry.value == option.value %}selected{% endif %}>
                {{ option.text or option.label }}
              </option>
            {% endif %}
          {% endfor %}
        </select>
      {% elif entry.type == 'checkbox' %}
        <div class="form-check">
          <input type="checkbox" class="form-check-input" id="{{ field_id }}" name="{{ field_id }}"
                 {% if entry.value %}checked{% endif %}>
          <label class="form-check-label" for="{{ field_id }}">{{ entry.label }}</label>
        </div>
      {% elif entry.type == 'date' %}
        <input type="date" class="form-control" id="{{ field_id }}" name="{{ field_id }}"
               value="{{ entry.value }}" {% if entry.required %}required{% endif %}>
      {% elif entry.type == 'number' %}
        <input type="number" class="form-control" id="{{ field_id }}" name="{{ field_id }}"
               value="{{ entry.value or '' }}" {% if entry.required %}required{% endif %}>
      {% elif entry.type == 'readonly' %}
        <div class="form-control-plaintext">{{ entry.value }}</div>
      {% elif entry.type == 'autocomplete' %}
        <input type="text" class="form-control autocomplete-input" id="{{ field_id }}" name="{{ field_id }}"
               value="{{ entry.value or '' }}" {% if entry.required %}required{% endif %}
               data-options="{{ entry.options|tojson if entry.options else '[]' }}">
      {% else %}
        <input type="text" class="form-control" id="{{ field_id }}" name="{{ field_id }}"
               value="{{ entry.value or '' }}" {% if entry.required %}required{% endif %}>
      {% endif %}

      {% if entry.help_text %}
        <div class="form-text text-muted">{{ entry.help_text }}</div>
      {% endif %}
    {% endif %}
  </div>
{% endmacro %}

{% macro render_fields_row(entries, read_only=false) %}
  <div class="row">
    {% for entry in entries %}
      {{ render_field(entry, read_only=read_only) }}
    {% endfor %}
  </div>
{% endmacro %}

{% macro render_form_section(title, entries, read_only=false) %}
  <div class="form-section mb-4">
    <h5 class="mb-3">{{ title }}</h5>
    <div class="row">
      {% for entry in entries %}
        {{ render_field(entry, read_only=read_only) }}
      {% endfor %}
    </div>
  </div>
{% endmacro %}

{% macro render_footer_buttons(entity=None, read_only=False) %}
  <div class="footer-buttons-container mt-4 d-flex justify-content-end gap-2">
    {% if not read_only %}
      {% if entity and entity.id %}
        <a href="{{ url_for(request.endpoint.rsplit('.', 1)[0] + '.view', entity_id=entity.id) }}" class="btn btn-secondary">
          <i class="fas fa-times me-1"></i> Cancel
        </a>
        <button type="submit" class="btn btn-primary" form="main-form">
          <i class="fas fa-save me-1"></i> Update
        </button>
      {% else %}
        <a href="{{ url_for(request.endpoint.rsplit('.', 1)[0] + '.index') }}" class="btn btn-secondary">
          <i class="fas fa-times me-1"></i> Cancel
        </a>
        <button type="submit" class="btn btn-primary" form="main-form">
          <i class="fas fa-save me-1"></i> Create
        </button>
      {% endif %}
    {% endif %}
  </div>
{% endmacro %}