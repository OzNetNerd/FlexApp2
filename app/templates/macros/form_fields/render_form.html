<!-- START TEMPLATE: render_form.html -->
{# ------------------------------------------------------------------------------
  File: render_form.html
  Purpose: Macro to render a full form with grouped sections and buttons
  Imports:
    - render_sections.html ‚Üí sections_macros (used to group and render sectioned fields)
  Macro:
    - render_form(fields_by_section, submit_url, cancel_url, button_text, read_only, edit_url)
      Renders a complete HTML form with fields grouped by section
  Inputs:
    - fields_by_section : dict[str, list[TabEntry]] ‚Äî section name to fields
    - submit_url        : str ‚Äî target URL for form submission
    - cancel_url        : str ‚Äî target URL for cancellation/back
    - button_text       : str ‚Äî text on the submit button
    - read_only         : bool ‚Äî toggle for read-only mode
    - edit_url          : str | None ‚Äî optional edit button destination
  Output:
    - HTML form with CSRF, dynamic section rendering, buttons
  Notes:
    - Logs render context to JS console for debugging
    - Handles edit/view-only dual-purpose rendering
    - CSRF token is only included if the form is editable
    - Shows "Edit" button in read-only mode if edit_url is set
    - Calls `render_sections` macro to lay out form fields from each section
------------------------------------------------------------------------------ #}

{# Import section-rendering macro as alias for grouping inputs visually and semantically #}
{% import "macros/form_fields/render_sections.html" as sections_macros %}

<script type="module">
  import log from "{{ url_for('static', filename='js/logger.js') }}";
  const filename = "render_form.html";

  log("info", filename, "init", "üì¶ Loaded form rendering macro");
  log("debug", filename, "import", "üîó Imported sections_macros from render_sections.html");
</script>

{# Main macro to render a form ‚Äî used across create, edit, and view pages #}
{% macro render_form(fields_by_section, submit_url, cancel_url, button_text="Submit", read_only=False, edit_url=None) -%}
  <script type="module">
    import log from "{{ url_for('static', filename='js/logger.js') }}";

    const filename = "render_form.html";
    const mode = {{ "true" if read_only else "false" }};
    const sectionNames = {{ fields_by_section.keys() | list | tojson | safe }};
    const submitUrl = {{ submit_url | tojson | safe }};
    const cancelUrl = {{ cancel_url | tojson | safe }};
    const editUrl = {{ edit_url | tojson | safe }};
    const btnText = {{ button_text | tojson | safe }};

    log("info", filename, "render_form", `üßæ Rendering form in ${mode === "true" ? "read-only" : "editable"} mode`);
    log("debug", filename, "render_form", "üìå Sections", sectionNames);
    log("debug", filename, "render_form", "‚û°Ô∏è Submit URL", submitUrl);
    log("debug", filename, "render_form", "‚Ü©Ô∏è Cancel URL", cancelUrl);
    log("debug", filename, "render_form", "‚úèÔ∏è Edit URL", editUrl);
    log("debug", filename, "render_form", "üîò Button text", btnText);
  </script>

  <form action="{{ submit_url }}" method="post" enctype="multipart/form-data">
    {# Include CSRF token only if the form is editable #}
    {%- if not read_only %}
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    {%- endif %}

    {# Render grouped form fields using imported sections macro #}
    {{ sections_macros.render_sections(fields_by_section, read_only) }}

    {#
      Action buttons section ‚Äî show different buttons depending on read-only mode.
      - If read_only is True and edit_url is provided:
          ‚Üí Show an "Edit" button linking to the edit form.
          ‚Üí Show a "Back" button that navigates to the cancel_url.
      - If read_only is False:
          ‚Üí Show a "Cancel" button linking to the cancel_url.
          ‚Üí Show a "Submit" button to save the form.
      - Icons and text adjust dynamically to reflect the current mode.
    #}
    <div class="d-flex justify-content-between mt-4">
      <a href="{{ cancel_url }}" class="btn btn-outline-secondary">
        <i class="fas fa-{{ 'arrow-left' if read_only else 'times' }} me-1"></i> {{ 'Back' if read_only else 'Cancel' }}
      </a>
      {%- if read_only and edit_url %}
        <a href="{{ edit_url }}" class="btn btn-primary">
          <i class="fas fa-edit me-1"></i> Edit
        </a>
      {%- elif not read_only %}
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-save me-1"></i> {{ button_text }}
        </button>
      {%- endif %}
    </div>
  </form>
{%- endmacro %}
<!-- END TEMPLATE: render_form.html -->