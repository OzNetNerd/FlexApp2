<!-- START TEMPLATE: view_edit_company.html -->

{% extends "base/create_view_edit/_create_view_edit.html" %}
{% set tabs = [
    {'tab_name': 'Notes'} if read_only else None,
    {'tab_name': 'About'},
    {'tab_name': 'Contacts'},
    {'tab_name': 'Opportunities'},
    {'tab_name': 'Capabilities'},
    {'tab_name': 'Insights'} if read_only else None,
    {'tab_name': 'System Info'} if read_only else None
] | reject('none') | list %}
{% import 'base/macros/render_form_fields.html' as field_macros with context %}
{% import 'base/macros/tabs.html' as tab_macros with context %}

{# Local macros for entity-related rendering #}
{% macro render_empty_state(message) %}
  <div class="form-control-plaintext bg-light border rounded px-3 py-2">
    {{ message }}
  </div>
{% endmacro %}

{% macro render_contacts_table(contacts) %}
  <div class="col-12">
    <label class="form-label fw-semibold">Contacts</label>
    {% if contacts %}
      <div class="table-responsive form-control-plaintext bg-light border rounded px-3 py-2">
        <table class="table table-hover mb-0">
          <thead>
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Phone</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for contact in contacts %}
            <tr>
              <td>{{ contact.name }}</td>
              <td>{{ contact.email|default('') }}</td>
              <td>{{ contact.phone|default('') }}</td>
              <td>
                <a href="/contacts/{{ contact.id }}" class="btn btn-sm btn-info">
                  <i class="fas fa-eye"></i>
                </a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      {{ render_empty_state('No contacts associated with this company.') }}
    {% endif %}
  </div>
{% endmacro %}

{% macro render_opportunities_table(opportunities) %}
  <div class="col-12">
    <label class="form-label fw-semibold">Opportunities</label>
    {% if opportunities %}
      <div class="table-responsive form-control-plaintext bg-light border rounded px-3 py-2">
        <table class="table table-hover mb-0">
          <thead>
            <tr>
              <th>Name</th>
              <th>Status</th>
              <th>Stage</th>
              <th>Value</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for opportunity in opportunities %}
            <tr>
              <td>{{ opportunity.name }}</td>
              <td>
                <span class="badge {% if opportunity.status == 'Open' %}bg-success{% elif opportunity.status == 'Closed' %}bg-danger{% else %}bg-secondary{% endif %}">
                  {{ opportunity.status }}
                </span>
              </td>
              <td>{{ opportunity.stage }}</td>
              <td>${{ opportunity.value|default('0.00') }}</td>
              <td>
                <a href="/opportunities/{{ opportunity.id }}" class="btn btn-sm btn-info">
                  <i class="fas fa-eye"></i>
                </a>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      {{ render_empty_state('No opportunities associated with this company.') }}
    {% endif %}
  </div>
{% endmacro %}

{% macro render_capabilities_list(capabilities) %}
  <div class="col-12">
    <label class="form-label fw-semibold">Capabilities</label>
    {% if capabilities %}
      <div class="form-control-plaintext bg-light border rounded px-3 py-2">
        <div class="list-group list-group-flush">
          {% for capability in capabilities %}
            <div class="list-group-item bg-transparent px-0 border-0 border-bottom">
              <div class="d-flex w-100 justify-content-between">
                <h5 class="mb-1">{{ capability.name }}</h5>
              </div>
              {% if capability.description %}
                <p class="mb-1">{{ capability.description }}</p>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      </div>
    {% else %}
      {{ render_empty_state('No capabilities defined for this company.') }}
    {% endif %}
  </div>
{% endmacro %}

{% block view_template_content %}
<form method="post" action="{{ submit_url }}">
  <div class="tab-content" id="formTabsContent">

    {% if read_only %}
    <!-- Tab Pane: Notes -->
    {% call tab_macros.render_tab_section('notes', 'Notes', active=true) %}
      {% include 'components/_notes_section.html' %}
    {% endcall %}
    {% endif %}

    <!-- Tab Pane: About -->
    {% call tab_macros.render_tab_section('about', 'Basic Info', active=not read_only) %}
      {{ field_macros.render_field({
          "entry_name": "name",
          "label": "Company Name",
          "type": "text",
          "value": entity.name,
          "required": true,
          "options": []
       }, read_only=read_only) }}
      {{ field_macros.render_field({
          "entry_name": "description",
          "label": "Description",
          "type": "textarea",
          "value": entity.description,
          "required": false,
          "options": []
       }, read_only=read_only) }}
    {% endcall %}

    <!-- Tab Pane: Contacts -->
    {% call tab_macros.render_tab_section('contacts', 'Related Contacts') %}
      {% if not read_only %}
        {{ field_macros.render_field({
            "entry_name": "contacts",
            "label": "Contacts",
            "type": "custom",
            "value": entity.contacts,
            "required": false,
            "options": []
        }, read_only=read_only) }}
      {% else %}
        {{ render_contacts_table(entity.contacts) }}
      {% endif %}
    {% endcall %}

    <!-- Tab Pane: Opportunities -->
    {% call tab_macros.render_tab_section('opportunities', 'Opportunities') %}
      {% if not read_only %}
        {{ field_macros.render_field({
            "entry_name": "opportunities",
            "label": "Opportunities",
            "type": "custom",
            "value": entity.opportunities,
            "required": false,
            "options": []
        }, read_only=read_only) }}
      {% else %}
        {{ render_opportunities_table(entity.opportunities) }}
      {% endif %}
    {% endcall %}

    <!-- Tab Pane: Capabilities -->
    {% call tab_macros.render_tab_section('capabilities', 'Capabilities') %}
      {% if not read_only %}
        {{ field_macros.render_field({
            "entry_name": "capabilities",
            "label": "Capabilities",
            "type": "custom",
            "value": entity.capabilities,
            "required": false,
            "options": []
        }, read_only=read_only) }}
      {% else %}
        {{ render_capabilities_list(entity.capabilities) }}
      {% endif %}
    {% endcall %}

    {% if read_only %}
    <!-- Tab Pane: Insights -->
    {% call tab_macros.render_tab_section('insights', 'Insights') %}
      {{ field_macros.render_field({
          "entry_name": "crisp_summary",
          "label": "CRISP Summary",
          "type": "text",
          "value": entity.crisp_summary,
          "required": false,
          "options": []
       }, read_only=true) }}
    {% endcall %}

    <!-- Tab Pane: System Info -->
    {% call tab_macros.render_tab_section('system-info', 'System Information') %}
      {{ field_macros.render_field({
          "entry_name": "created_at",
          "label": "Created At",
          "type": "datetime",
          "value": entity.created_at,
          "required": false,
          "options": []
       }, read_only=true) }}
      {{ field_macros.render_field({
          "entry_name": "updated_at",
          "label": "Updated At",
          "type": "datetime",
          "value": entity.updated_at,
          "required": false,
          "options": []
       }, read_only=true) }}
    {% endcall %}
    {% endif %}

  </div>
</form>
{% endblock view_template_content %}