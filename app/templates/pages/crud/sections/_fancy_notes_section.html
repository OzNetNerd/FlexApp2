{% block title %}{!entity_type|capitalize !} Notes - {!entity_name !}{% endblock %}

{% block content %}
<div class="notes-container">
  <div class="header-section">
    <h1>{!entity_name !}</h1>
    <div class="entity-meta">
      <span class="entity-type">{!entity_type|capitalize !}</span>
      {% if entity_id %}
      <span class="entity-id">#{!entity_id !}</span>
      {% endif %}
      {% if owner %}
      <span class="entity-owner">Owner: {!owner.name !}</span>
      {% endif %}
    </div>
  </div>

  <!-- Tabs Navigation -->
  <div class="tabs-navigation">
    <ul class="nav nav-tabs" id="notesTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab" aria-controls="overview" aria-selected="true">Overview</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="notes-tab" data-bs-toggle="tab" data-bs-target="#notes" type="button" role="tab" aria-controls="notes" aria-selected="false">Notes History</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="next-steps-tab" data-bs-toggle="tab" data-bs-target="#next-steps" type="button" role="tab" aria-controls="next-steps" aria-selected="false">Next Steps</button>
      </li>
      {% if entity_type == 'opportunity' %}
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="sales-tab" data-bs-toggle="tab" data-bs-target="#sales" type="button" role="tab" aria-controls="sales" aria-selected="false">Sales Details</button>
      </li>
      {% endif %}
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="documents-tab" data-bs-toggle="tab" data-bs-target="#documents" type="button" role="tab" aria-controls="documents" aria-selected="false">Documents</button>
      </li>
    </ul>
  </div>

  <!-- Tabs Content -->
  <div class="tab-content" id="notesTabsContent">
    <!-- Overview Tab -->
    <div class="tab-pane fade show active" id="overview" role="tabpanel" aria-labelledby="overview-tab">
      <div class="overview-section">
        <div class="row">
          <div class="col-md-8">
            <div class="card">
              <div class="card-header">
                <h5>Summary</h5>
              </div>
              <div class="card-body">
                {% if entity.summary %}
                <p>{!entity.summary !}</p>
                {% else %}
                <p class="text-muted">No summary information available.</p>
                {% endif %}

                <div class="form-group mt-3">
                  <form action="{!url_for('update_summary', entity_type=entity_type, entity_id=entity_id) !}" method="POST">
                    <label for="summaryEditor">Update Summary:</label>
                    <textarea class="form-control" id="summaryEditor" name="summary" rows="4">{!entity.summary !}</textarea>
                    <button type="submit" class="btn btn-primary mt-2">Save Summary</button>
                  </form>
                </div>
              </div>
            </div>

            <div class="card mt-3">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h5>Recent Activity</h5>
                <span class="badge bg-secondary">Last 30 days</span>
              </div>
              <div class="card-body">
                {% if recent_activities %}
                <ul class="activity-timeline">
                  {% for activity in recent_activities %}
                  <li class="activity-item">
                    <div class="activity-icon {!activity.type !}">
                      <i class="fa fa-{!activity.icon !}"></i>
                    </div>
                    <div class="activity-content">
                      <div class="activity-time">{!activity.timestamp !}</div>
                      <div class="activity-text">{!activity.description !}</div>
                      <div class="activity-user">by {!activity.user.name !}</div>
                    </div>
                  </li>
                  {% endfor %}
                </ul>
                {% else %}
                <p class="text-muted">No recent activity.</p>
                {% endif %}
              </div>
            </div>
          </div>

          <div class="col-md-4">
            <div class="card">
              <div class="card-header">
                <h5>Key Details</h5>
              </div>
              <div class="card-body">
                <ul class="key-details-list">
                  {% if entity_type == 'company' %}
                    <li><strong>Industry:</strong> {!entity.industry|default('N/A') !}</li>
                    <li><strong>Size:</strong> {!entity.size|default('N/A') !}</li>
                    <li><strong>Location:</strong> {!entity.location|default('N/A') !}</li>
                    <li><strong>Website:</strong>
                      {% if entity.website %}
                        <a href="{!entity.website !}" target="_blank">{!entity.website !}</a>
                      {% else %}
                        N/A
                      {% endif %}
                    </li>
                  {% elif entity_type == 'contact' %}
                    <li><strong>Company:</strong> {!entity.company.name|default('N/A') !}</li>
                    <li><strong>Title:</strong> {!entity.title|default('N/A') !}</li>
                    <li><strong>Email:</strong> {!entity.email|default('N/A') !}</li>
                    <li><strong>Phone:</strong> {!entity.phone|default('N/A') !}</li>
                  {% elif entity_type == 'opportunity' %}
                    <li><strong>Value:</strong> ${!entity.value !}</li>
                    <li><strong>Stage:</strong> <span class="badge bg-{!entity.stage_color !}">{!entity.stage !}</span></li>
                    <li><strong>Close Date:</strong> {!entity.close_date !}</li>
                    <li><strong>Probability:</strong> {!entity.probability !}%</li>
                  {% endif %}
                  <li><strong>Created:</strong> {!entity.created_at !}</li>
                  <li><strong>Last Updated:</strong> {!entity.updated_at !}</li>
                </ul>
                <a href="{!url_for('edit_entity', entity_type=entity_type, entity_id=entity_id) !}" class="btn btn-outline-primary btn-sm mt-2">Edit Details</a>
              </div>
            </div>

            <div class="card mt-3">
              <div class="card-header">
                <h5>Upcoming Tasks</h5>
              </div>
              <div class="card-body">
                {% if upcoming_tasks %}
                <ul class="task-list">
                  {% for task in upcoming_tasks %}
                  <li class="task-item {% if task.is_overdue %}overdue{% endif %}">
                    <div class="form-check">
                      <input class="form-check-input task-checkbox" type="checkbox" value="{!task.id !}" id="task{!task.id !}" {% if task.completed %}checked{% endif %}>
                      <label class="form-check-label" for="task{!task.id !}">
                        {!task.title !}
                      </label>
                    </div>
                    <div class="task-meta">
                      <span class="task-due-date">Due: {!task.due_date !}</span>
                    </div>
                  </li>
                  {% endfor %}
                </ul>
                <a href="#" class="btn btn-outline-primary btn-sm mt-2" data-bs-toggle="modal" data-bs-target="#addTaskModal">Add Task</a>
                {% else %}
                <p class="text-muted">No upcoming tasks.</p>
                <a href="#" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addTaskModal">Add Task</a>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Notes History Tab -->
    <div class="tab-pane fade" id="notes" role="tabpanel" aria-labelledby="notes-tab">
      <div class="notes-section">
        <div class="add-note-form mb-4">
          <h5>Add New Note</h5>
          <form action="{!url_for('add_note', entity_type=entity_type, entity_id=entity_id) !}" method="POST">
            <div class="form-group">
              <label for="noteContent">Note Content:</label>
              <textarea class="form-control" id="noteContent" name="content" rows="3" required></textarea>
            </div>
            <div class="form-group">
              <label for="noteType">Note Type:</label>
              <select class="form-select" id="noteType" name="note_type">
                <option value="general">General</option>
                <option value="meeting">Meeting</option>
                <option value="call">Call</option>
                <option value="email">Email</option>
              </select>
            </div>
            <button type="submit" class="btn btn-primary mt-2">Save Note</button>
          </form>
        </div>

        <div class="notes-history">
          <h5>Notes History</h5>
          <div class="notes-filter mb-3">
            <div class="row">
              <div class="col-md-4">
                <input type="text" class="form-control" id="searchNotes" placeholder="Search notes...">
              </div>
              <div class="col-md-3">
                <select class="form-select" id="filterNoteType">
                  <option value="">All Types</option>
                  <option value="general">General</option>
                  <option value="meeting">Meeting</option>
                  <option value="call">Call</option>
                  <option value="email">Email</option>
                </select>
              </div>
              <div class="col-md-3">
                <select class="form-select" id="sortNotes">
                  <option value="newest">Newest First</option>
                  <option value="oldest">Oldest First</option>
                </select>
              </div>
            </div>
          </div>

          {% if notes %}
          <div class="notes-list">
            {% for note in notes %}
            <div class="note-card" data-note-type="{!note.type !}">
              <div class="note-header">
                <div class="note-type note-type-{!note.type !}">
                  <i class="fa fa-{!note.icon !}"></i> {!note.type|capitalize !}
                </div>
                <div class="note-meta">
                  <span class="note-author">{!note.author.name !}</span>
                  <span class="note-date">{!note.created_at !}</span>
                </div>
              </div>
              <div class="note-content">
                {!note.content !}
              </div>
              <div class="note-actions">
                <a href="#" class="edit-note" data-note-id="{!note.id !}"><i class="fa fa-edit"></i> Edit</a>
                <a href="#" class="delete-note" data-note-id="{!note.id !}"><i class="fa fa-trash"></i> Delete</a>
              </div>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <p class="text-muted">No notes available.</p>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Next Steps Tab -->
    <div class="tab-pane fade" id="next-steps" role="tabpanel" aria-labelledby="next-steps-tab">
      <div class="next-steps-section">
        <div class="row">
          <div class="col-md-8">
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h5>Action Items</h5>
                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#addActionItemModal">Add Action Item</button>
              </div>
              <div class="card-body">
                {% if action_items %}
                <div class="table-responsive">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        <th style="width: 5%">Status</th>
                        <th style="width: 40%">Description</th>
                        <th style="width: 15%">Assigned To</th>
                        <th style="width: 15%">Due Date</th>
                        <th style="width: 15%">Priority</th>
                        <th style="width: 10%">Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for item in action_items %}
                      <tr class="{% if item.is_overdue and not item.completed %}table-danger{% elif item.completed %}table-success{% endif %}">
                        <td>
                          <div class="form-check">
                            <input class="form-check-input action-checkbox" type="checkbox" value="{!item.id !}" id="action{!item.id !}" {% if item.completed %}checked{% endif %}>
                            <label class="form-check-label" for="action{!item.id !}"></label>
                          </div>
                        </td>
                        <td>{!item.description !}</td>
                        <td>{!item.assigned_to.name !}</td>
                        <td>{!item.due_date !}</td>
                        <td>
                          <span class="badge bg-{!item.priority_color !}">{!item.priority !}</span>
                        </td>
                        <td>
                          <div class="btn-group">
                            <button type="button" class="btn btn-sm btn-outline-secondary edit-action" data-action-id="{!item.id !}">
                              <i class="fa fa-edit"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger delete-action" data-action-id="{!item.id !}">
                              <i class="fa fa-trash"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
                {% else %}
                <p class="text-muted">No action items available.</p>
                {% endif %}
              </div>
            </div>

            <div class="card mt-3">
              <div class="card-header">
                <h5>Action Plan</h5>
              </div>
              <div class="card-body">
                <form action="{!url_for('update_action_plan', entity_type=entity_type, entity_id=entity_id) !}" method="POST">
                  <div class="form-group">
                    <label for="actionPlanEditor">Action Plan:</label>
                    <textarea class="form-control" id="actionPlanEditor" name="action_plan" rows="6">{!entity.action_plan|default('') !}</textarea>
                  </div>
                  <button type="submit" class="btn btn-primary mt-2">Save Action Plan</button>
                </form>
              </div>
            </div>
          </div>

          <div class="col-md-4">
            <div class="card">
              <div class="card-header">
                <h5>Milestones</h5>
              </div>
              <div class="card-body">
                {% if milestones %}
                <div class="milestone-timeline">
                  {% for milestone in milestones %}
                  <div class="milestone-item {% if milestone.completed %}completed{% endif %}">
                    <div class="milestone-marker"></div>
                    <div class="milestone-content">
                      <div class="milestone-title">{!milestone.title !}</div>
                      <div class="milestone-date">{!milestone.target_date !}</div>
                      <div class="milestone-status">
                        <span class="badge bg-{!milestone.status_color !}">{!milestone.status !}</span>
                      </div>
                      <div class="milestone-actions mt-2">
                        <button class="btn btn-sm btn-outline-primary edit-milestone" data-milestone-id="{!milestone.id !}">
                          <i class="fa fa-edit"></i> Edit
                        </button>
                      </div>
                    </div>
                  </div>
                  {% endfor %}
                </div>
                <button class="btn btn-outline-primary btn-sm mt-3" data-bs-toggle="modal" data-bs-target="#addMilestoneModal">Add Milestone</button>
                {% else %}
                <p class="text-muted">No milestones defined.</p>
                <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addMilestoneModal">Add Milestone</button>
                {% endif %}
              </div>
            </div>

            <div class="card mt-3">
              <div class="card-header">
                <h5>Follow-ups</h5>
              </div>
              <div class="card-body">
                <div class="form-group">
                  <label for="followupDate">Next Follow-up Date:</label>
                  <input type="date" class="form-control" id="followupDate" name="followup_date" value="{!entity.next_followup !}" min="{!today !}">
                </div>
                <div class="form-group mt-2">
                  <label for="followupType">Follow-up Type:</label>
                  <select class="form-select" id="followupType" name="followup_type">
                    <option value="call" {% if entity.followup_type == 'call' %}selected{% endif %}>Call</option>
                    <option value="meeting" {% if entity.followup_type == 'meeting' %}selected{% endif %}>Meeting</option>
                    <option value="email" {% if entity.followup_type == 'email' %}selected{% endif %}>Email</option>
                    <option value="other" {% if entity.followup_type == 'other' %}selected{% endif %}>Other</option>
                  </select>
                </div>
                <div class="form-group mt-2">
                  <label for="followupNotes">Follow-up Notes:</label>
                  <textarea class="form-control" id="followupNotes" name="followup_notes" rows="3">{!entity.followup_notes|default('') !}</textarea>
                </div>
                <button type="button" class="btn btn-primary mt-2 save-followup">Save Follow-up</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    {% if entity_type == 'opportunity' %}
    <!-- Sales Details Tab (Only for Opportunities) -->
    <div class="tab-pane fade" id="sales" role="tabpanel" aria-labelledby="sales-tab">
      <div class="sales-section">
        <div class="row">
          <div class="col-md-8">
            <div class="card">
              <div class="card-header">
                <h5>Deal Information</h5>
              </div>
              <div class="card-body">
                <form action="{!url_for('update_opportunity', entity_id=entity_id) !}" method="POST">
                  <div class="row">
                    <div class="col-md-6">
                      <div class="form-group">
                        <label for="dealValue">Deal Value:</label>
                        <div class="input-group">
                          <span class="input-group-text">$</span>
                          <input type="number" class="form-control" id="dealValue" name="value" value="{!entity.value !}" min="0" step="0.01">
                        </div>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="form-group">
                        <label for="dealStage">Deal Stage:</label>
                        <select class="form-select" id="dealStage" name="stage">
                          <option value="prospecting" {% if entity.stage == 'prospecting' %}selected{% endif %}>Prospecting</option>
                          <option value="qualification" {% if entity.stage == 'qualification' %}selected{% endif %}>Qualification</option>
                          <option value="proposal" {% if entity.stage == 'proposal' %}selected{% endif %}>Proposal</option>
                          <option value="negotiation" {% if entity.stage == 'negotiation' %}selected{% endif %}>Negotiation</option>
                          <option value="closing" {% if entity.stage == 'closing' %}selected{% endif %}>Closing</option>
                          <option value="won" {% if entity.stage == 'won' %}selected{% endif %}>Won</option>
                          <option value="lost" {% if entity.stage == 'lost' %}selected{% endif %}>Lost</option>
                        </select>
                      </div>
                    </div>
                  </div>

                  <div class="row mt-3">
                    <div class="col-md-6">
                      <div class="form-group">
                        <label for="closeProbability">Probability (%):</label>
                        <input type="range" class="form-range" id="closeProbability" name="probability" min="0" max="100" step="5" value="{!entity.probability !}">
                        <output for="closeProbability" id="probabilityOutput">{!entity.probability !}%</output>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="form-group">
                        <label for="closeDate">Expected Close Date:</label>
                        <input type="date" class="form-control" id="closeDate" name="close_date" value="{!entity.close_date !}">
                      </div>
                    </div>
                  </div>

                  <div class="form-group mt-3">
                    <label for="dealSource">Deal Source:</label>
                    <select class="form-select" id="dealSource" name="source">
                      <option value="referral" {% if entity.source == 'referral' %}selected{% endif %}>Referral</option>
                      <option value="website" {% if entity.source == 'website' %}selected{% endif %}>Website</option>
                      <option value="cold_call" {% if entity.source == 'cold_call' %}selected{% endif %}>Cold Call</option>
                      <option value="conference" {% if entity.source == 'conference' %}selected{% endif %}>Conference</option>
                      <option value="partner" {% if entity.source == 'partner' %}selected{% endif %}>Partner</option>
                      <option value="social_media" {% if entity.source == 'social_media' %}selected{% endif %}>Social Media</option>
                      <option value="other" {% if entity.source == 'other' %}selected{% endif %}>Other</option>
                    </select>
                  </div>

                  <div class="form-group mt-3">
                    <label for="lossReason" id="lossReasonLabel" {% if entity.stage != 'lost' %}style="display: none;"{% endif %}>Loss Reason:</label>
                    <select class="form-select" id="lossReason" name="loss_reason" {% if entity.stage != 'lost' %}style="display: none;"{% endif %}>
                      <option value="">Select a reason</option>
                      <option value="price" {% if entity.loss_reason == 'price' %}selected{% endif %}>Price</option>
                      <option value="features" {% if entity.loss_reason == 'features' %}selected{% endif %}>Missing Features</option>
                      <option value="competitor" {% if entity.loss_reason == 'competitor' %}selected{% endif %}>Chose Competitor</option>
                      <option value="timing" {% if entity.loss_reason == 'timing' %}selected{% endif %}>Bad Timing</option>
                      <option value="budget" {% if entity.loss_reason == 'budget' %}selected{% endif %}>No Budget</option>
                      <option value="other" {% if entity.loss_reason == 'other' %}selected{% endif %}>Other</option>
                    </select>
                  </div>

                  <button type="submit" class="btn btn-primary mt-3">Update Deal</button>
                </form>
              </div>
            </div>

            <div class="card mt-3">
              <div class="card-header">
                <h5>Products & Services</h5>
              </div>
              <div class="card-body">
                {% if deal_products %}
                <div class="table-responsive">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        <th>Product/Service</th>
                        <th>Quantity</th>
                        <th>Unit Price</th>
                        <th>Discount</th>
                        <th>Total</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for item in deal_products %}
                      <tr>
                        <td>{!item.product.name !}</td>
                        <td>{!item.quantity !}</td>
                        <td>${!item.unit_price !}</td>
                        <td>{!item.discount !}%</td>
                        <td>${!item.total !}</td>
                        <td>
                          <div class="btn-group">
                            <button type="button" class="btn btn-sm btn-outline-secondary edit-product" data-product-id="{!item.id !}">
                              <i class="fa fa-edit"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger delete-product" data-product-id="{!item.id !}">
                              <i class="fa fa-trash"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                    <tfoot>
                      <tr>
                        <td colspan="4" class="text-end"><strong>Subtotal:</strong></td>
                        <td>${!entity.subtotal !}</td>
                        <td></td>
                      </tr>
                      <tr>
                        <td colspan="4" class="text-end"><strong>Tax ({!entity.tax_rate !}%):</strong></td>
                        <td>${!entity.tax_amount !}</td>
                        <td></td>
                      </tr>
                      <tr>
                        <td colspan="4" class="text-end"><strong>Total:</strong></td>
                        <td>${!entity.total !}</td>
                        <td></td>
                      </tr>
                    </tfoot>
                  </table>
                </div>
                <button class="btn btn-outline-primary btn-sm mt-2" data-bs-toggle="modal" data-bs-target="#addProductModal">Add Product/Service</button>
                {% else %}
                <p class="text-muted">No products or services added to this deal.</p>
                <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addProductModal">Add Product/Service</button>
                {% endif %}
              </div>
            </div>
          </div>

          <div class="col-md-4">
            <div class="card">
              <div class="card-header">
                <h5>Key Decision Makers</h5>
              </div>
              <div class="card-body">
                {% if decision_makers %}
                <ul class="decision-makers-list">
                  {% for contact in decision_makers %}
                  <li class="decision-maker-item">
                    <div class="decision-maker-info">
                      <div class="decision-maker-name">{!contact.name !}</div>
                      <div class="decision-maker-title">{!contact.title !}</div>
                      <div class="decision-maker-contact">
                        <a href="mailto:{!contact.email !}">{!contact.email !}</a> |
                        <a href="tel:{!contact.phone !}">{!contact.phone !}</a>
                      </div>
                      <div class="decision-maker-role">
                        <span class="badge bg-info">{!contact.role !}</span>
                      </div>
                    </div>
                    <div class="decision-maker-actions">
                      <a href="{!url_for('view_contact', contact_id=contact.id) !}" class="btn btn-sm btn-outline-secondary">View</a>
                    </div>
                  </li>
                  {% endfor %}
                </ul>
                <button class="btn btn-outline-primary btn-sm mt-2" data-bs-toggle="modal" data-bs-target="#addDecisionMakerModal">Add Decision Maker</button>
                {% else %}
                <p class="text-muted">No decision makers added.</p>
                <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addDecisionMakerModal">Add Decision Maker</button>
                {% endif %}
              </div>
            </div>

            <div class="card mt-3">
              <div class="card-header">
                <h5>Competitors</h5>
              </div>
              <div class="card-body">
                {% if competitors %}
                <ul class="competitors-list">
                  {% for competitor in competitors %}
                  <li class="competitor-item">
                    <div class="competitor-name">{!competitor.name !}</div>
                    <div class="competitor-threat">
                      <div class="progress">
                        <div class="progress-bar bg-danger" role="progressbar" style="width: {!competitor.threat_level !}%;" aria-valuenow="{!competitor.threat_level !}" aria-valuemin="0" aria-valuemax="100">{!competitor.threat_level !}%</div>
                      </div>
                    </div>
                    <div class="competitor-strengths mt-1">
                      <small>{!competitor.strengths !}</small>
                    </div>
                  </li>
                  {% endfor %}
                </ul>
                <button class="btn btn-outline-primary btn-sm mt-2" data-bs-toggle="modal" data-bs-target="#addCompetitorModal">Add Competitor</button>
                {% else %}
                <p class="text-muted">No competitors identified.</p>
                <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addCompetitorModal">Add Competitor</button>
                {% endif %}
              </div>
            </div>

            <div class="card mt-3">
              <div class="card-header">
                <h5>Sales Forecast</h5>
              </div>
              <div class="card-body">
                <div class="forecast-chart">
                  <canvas id="forecastChart" width="100%" height="200"></canvas>
                </div>
                <div class="forecast-stats mt-3">
                  <div class="row">
                    <div class="col-6">
                      <div class="forecast-stat">
                        <div class="forecast-label">Win Probability</div>
                        <div class="forecast-value">{!entity.probability !}%</div>
                      </div>
                    </div>
                    <div class="col-6">
                      <div class="forecast-stat">
                        <div class="forecast-label">Days to Close</div>
                        <div class="forecast-value">{!entity.days_to_close !}</div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- Documents Tab -->
    <div class="tab-pane fade" id="documents" role="tabpanel" aria-labelledby="documents-tab">
      <div class="documents-section">
        <div class="row">
          <div class="col-md-8">
            <div class="card">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h5>Uploaded Documents</h5>
                <button class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#uploadDocumentModal">Upload Document</button>
              </div>
              <div class="card-body">
                {% if documents %}
                <div class="table-responsive">
                  <table class="table table-hover">
                    <thead>
                      <tr>
                        <th>Document Name</th>
                        <th>Type</th>
                        <th>Size</th>
                        <th>Uploaded</th>
                        <th>Uploaded By</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for doc in documents %}
                      <tr>
                        <td>
                          <a href="{!url_for('view_document', document_id=doc.id) !}" target="_blank">
                            <i class="fa fa-{!doc.icon !}"></i> {!doc.name !}
                          </a>
                        </td>
                        <td>{!doc.type !}</td>
                        <td>{!doc.size !}</td>
                        <td>{!doc.uploaded_at !}</td>
                        <td>{!doc.uploaded_by.name !}</td>
                        <td>
                          <div class="btn-group">
                            <a href="{!url_for('download_document', document_id=doc.id) !}" class="btn btn-sm btn-outline-primary">
                              <i class="fa fa-download"></i>
                            </a>
                            <button type="button" class="btn btn-sm btn-outline-secondary rename-document" data-document-id="{!doc.id !}">
                              <i class="fa fa-edit"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger delete-document" data-document-id="{!doc.id !}">
                              <i class="fa fa-trash"></i>
                            </button>
                          </div>
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
                {% else %}
                <p class="text-muted">No documents uploaded.</p>
                {% endif %}
              </div>
            </div>
          </div>

          <div class="col-md-4">
            <div class="card">
              <div class="card-header">
                <h5>Document Tags</h5>
              </div>
              <div class="card-body">
                <div class="document-tags">
                  {% if document_tags %}
                  <div class="tag-cloud">
                    {% for tag in document_tags %}
                    <span class="badge bg-secondary tag-item" data-tag-id="{!tag.id !}">
                      {!tag.name !} ({!tag.count !})
                      <i class="fa fa-times tag-remove"></i>
                    </span>
                    {% endfor %}
                  </div>
                  <div class="tag-actions mt-3">
                    <button class="btn btn-sm btn-outline-primary add-tag" data-bs-toggle="modal" data-bs-target="#addTagModal">Add Tag</button>
                  </div>
                  {% else %}
                  <p class="text-muted">No document tags available.</p>
                  <button class="btn btn-sm btn-outline-primary add-tag" data-bs-toggle="modal" data-bs-target="#addTagModal">Add Tag</button>
                  {% endif %}
                </div>
              </div>
            </div>

            <div class="card mt-3">
              <div class="card-header">
                <h5>Recent Templates</h5>
              </div>
              <div class="card-body">
                {% if document_templates %}
                <ul class="templates-list">
                  {% for template in document_templates %}
                  <li class="template-item">
                    <div class="template-icon">
                      <i class="fa fa-{!template.icon !}"></i>
                    </div>
                    <div class="template-info">
                      <div class="template-name">{!template.name !}</div>
                      <div class="template-type">{!template.type !}</div>
                    </div>
                    <div class="template-actions">
                      <button class="btn btn-sm btn-outline-primary use-template" data-template-id="{!template.id !}">
                        Use
                      </button>
                    </div>
                  </li>
                  {% endfor %}
                </ul>
                <a href="{!url_for('document_templates') !}" class="btn btn-outline-secondary btn-sm mt-2">All Templates</a>
                {% else %}
                <p class="text-muted">No document templates available.</p>
                <a href="{!url_for('document_templates') !}" class="btn btn-outline-secondary btn-sm">Browse Templates</a>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modals -->
<!-- Add Task Modal -->
<div class="modal fade" id="addTaskModal" tabindex="-1" aria-labelledby="addTaskModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addTaskModalLabel">Add New Task</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="taskForm" action="{!url_for('add_task', entity_type=entity_type, entity_id=entity_id) !}" method="POST">
          <div class="form-group">
            <label for="taskTitle">Task Title:</label>
            <input type="text" class="form-control" id="taskTitle" name="title" required>
          </div>
          <div class="form-group mt-2">
            <label for="taskDescription">Description:</label>
            <textarea class="form-control" id="taskDescription" name="description" rows="3"></textarea>
          </div>
          <div class="form-group mt-2">
            <label for="taskDueDate">Due Date:</label>
            <input type="date" class="form-control" id="taskDueDate" name="due_date" required>
          </div>
          <div class="form-group mt-2">
            <label for="taskAssignee">Assign To:</label>
            <select class="form-select" id="taskAssignee" name="assignee_id">
              {% for user in users %}
              <option value="{!user.id !}" {% if user.id == current_user.id %}selected{% endif %}>{!user.name !}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group mt-2">
            <label for="taskPriority">Priority:</label>
            <select class="form-select" id="taskPriority" name="priority">
              <option value="low">Low</option>
              <option value="medium" selected>Medium</option>
              <option value="high">High</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" form="taskForm" class="btn btn-primary">Add Task</button>
      </div>
    </div>
  </div>
</div>

<!-- Add Action Item Modal -->
<div class="modal fade" id="addActionItemModal" tabindex="-1" aria-labelledby="addActionItemModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addActionItemModalLabel">Add Action Item</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="actionItemForm" action="{!url_for('add_action_item', entity_type=entity_type, entity_id=entity_id) !}" method="POST">
          <div class="form-group">
            <label for="actionDescription">Description:</label>
            <textarea class="form-control" id="actionDescription" name="description" rows="3" required></textarea>
          </div>
          <div class="form-group mt-2">
            <label for="actionAssignee">Assigned To:</label>
            <select class="form-select" id="actionAssignee" name="assigned_to">
              {% for user in users %}
              <option value="{!user.id !}" {% if user.id == current_user.id %}selected{% endif %}>{!user.name !}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group mt-2">
            <label for="actionDueDate">Due Date:</label>
            <input type="date" class="form-control" id="actionDueDate" name="due_date" required>
          </div>
          <div class="form-group mt-2">
            <label for="actionPriority">Priority:</label>
            <select class="form-select" id="actionPriority" name="priority">
              <option value="low">Low</option>
              <option value="medium" selected>Medium</option>
              <option value="high">High</option>
              <option value="critical">Critical</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" form="actionItemForm" class="btn btn-primary">Add Action Item</button>
      </div>
    </div>
  </div>
</div>

<!-- Add Milestone Modal -->
<div class="modal fade" id="addMilestoneModal" tabindex="-1" aria-labelledby="addMilestoneModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addMilestoneModalLabel">Add Milestone</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="milestoneForm" action="{!url_for('add_milestone', entity_type=entity_type, entity_id=entity_id) !}" method="POST">
          <div class="form-group">
            <label for="milestoneTitle">Milestone Title:</label>
            <input type="text" class="form-control" id="milestoneTitle" name="title" required>
          </div>
          <div class="form-group mt-2">
            <label for="milestoneDescription">Description:</label>
            <textarea class="form-control" id="milestoneDescription" name="description" rows="3"></textarea>
          </div>
          <div class="form-group mt-2">
            <label for="milestoneDate">Target Date:</label>
            <input type="date" class="form-control" id="milestoneDate" name="target_date" required>
          </div>
          <div class="form-group mt-2">
            <label for="milestoneStatus">Status:</label>
            <select class="form-select" id="milestoneStatus" name="status">
              <option value="planned" selected>Planned</option>
              <option value="in_progress">In Progress</option>
              <option value="completed">Completed</option>
              <option value="delayed">Delayed</option>
              <option value="cancelled">Cancelled</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" form="milestoneForm" class="btn btn-primary">Add Milestone</button>
      </div>
    </div>
  </div>
</div>

<!-- Upload Document Modal -->
<div class="modal fade" id="uploadDocumentModal" tabindex="-1" aria-labelledby="uploadDocumentModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="uploadDocumentModalLabel">Upload Document</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="documentForm" action="{!url_for('upload_document', entity_type=entity_type, entity_id=entity_id) !}" method="POST" enctype="multipart/form-data">
          <div class="form-group">
            <label for="documentFile">Select File:</label>
            <input type="file" class="form-control" id="documentFile" name="file" required>
          </div>
          <div class="form-group mt-2">
            <label for="documentName">Document Name (optional):</label>
            <input type="text" class="form-control" id="documentName" name="name" placeholder="Leave blank to use filename">
          </div>
          <div class="form-group mt-2">
            <label for="documentType">Document Type:</label>
            <select class="form-select" id="documentType" name="document_type">
              <option value="contract">Contract</option>
              <option value="proposal">Proposal</option>
              <option value="invoice">Invoice</option>
              <option value="report">Report</option>
              <option value="presentation">Presentation</option>
              <option value="other" selected>Other</option>
            </select>
          </div>
          <div class="form-group mt-2">
            <label for="documentTags">Tags (comma separated):</label>
            <input type="text" class="form-control" id="documentTags" name="tags">
          </div>
          <div class="form-group mt-2">
            <label for="documentDescription">Description:</label>
            <textarea class="form-control" id="documentDescription" name="description" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" form="documentForm" class="btn btn-primary">Upload</button>
      </div>
    </div>
  </div>
</div>

<!-- Add Product Modal (for Opportunities) -->
{% if entity_type == 'opportunity' %}
<div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="addProductModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addProductModalLabel">Add Product/Service</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="productForm" action="{!url_for('add_product', entity_id=entity_id) !}" method="POST">
          <div class="form-group">
            <label for="productSelect">Product/Service:</label>
            <select class="form-select" id="productSelect" name="product_id" required>
              <option value="">Select a product/service</option>
              {% for product in products %}
              <option value="{!product.id !}" data-price="{!product.price !}">{!product.name !}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group mt-2">
            <label for="productQuantity">Quantity:</label>
            <input type="number" class="form-control" id="productQuantity" name="quantity" value="1" min="1" required>
          </div>
          <div class="form-group mt-2">
            <label for="productPrice">Unit Price ($):</label>
            <input type="number" class="form-control" id="productPrice" name="unit_price" step="0.01" min="0" required>
          </div>
          <div class="form-group mt-2">
            <label for="productDiscount">Discount (%):</label>
            <input type="number" class="form-control" id="productDiscount" name="discount" value="0" min="0" max="100">
          </div>
          <div class="form-group mt-2">
            <label for="productTotal">Total:</label>
            <input type="text" class="form-control" id="productTotal" readonly>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" form="productForm" class="btn btn-primary">Add Product</button>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Add Decision Maker Modal (for Opportunities) -->
{% if entity_type == 'opportunity' %}
<div class="modal fade" id="addDecisionMakerModal" tabindex="-1" aria-labelledby="addDecisionMakerModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addDecisionMakerModalLabel">Add Decision Maker</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="decisionMakerForm" action="{!url_for('add_decision_maker', entity_id=entity_id) !}" method="POST">
          <div class="form-group">
            <label for="contactSelect">Contact:</label>
            <select class="form-select" id="contactSelect" name="contact_id" required>
              <option value="">Select a contact</option>
              {% for contact in available_contacts %}
              <option value="{!contact.id !}">{!contact.name !} - {!contact.title !}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-group mt-2">
            <label for="contactRole">Role in Decision:</label>
            <select class="form-select" id="contactRole" name="role">
              <option value="decision_maker">Decision Maker</option>
              <option value="influencer">Influencer</option>
              <option value="evaluator">Evaluator</option>
              <option value="gatekeeper">Gatekeeper</option>
              <option value="user">End User</option>
              <option value="champion">Champion</option>
              <option value="blocker">Blocker</option>
            </select>
          </div>
          <div class="form-group mt-2">
            <label for="contactInfluence">Influence Level (%):</label>
            <input type="range" class="form-range" id="contactInfluence" name="influence" min="0" max="100" step="10" value="50">
            <output for="contactInfluence" id="influenceOutput">50%</output>
          </div>
          <div class="form-group mt-2">
            <label for="contactNotes">Notes:</label>
            <textarea class="form-control" id="contactNotes" name="notes" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" form="decisionMakerForm" class="btn btn-primary">Add Decision Maker</button>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Add Competitor Modal (for Opportunities) -->
{% if entity_type == 'opportunity' %}
<div class="modal fade" id="addCompetitorModal" tabindex="-1" aria-labelledby="addCompetitorModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addCompetitorModalLabel">Add Competitor</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="competitorForm" action="{!url_for('add_competitor', entity_id=entity_id) !}" method="POST">
          <div class="form-group">
            <label for="competitorName">Competitor Name:</label>
            <input type="text" class="form-control" id="competitorName" name="name" required>
          </div>
          <div class="form-group mt-2">
            <label for="competitorThreat">Threat Level (%):</label>
            <input type="range" class="form-range" id="competitorThreat" name="threat_level" min="0" max="100" step="5" value="50">
            <output for="competitorThreat" id="threatOutput">50%</output>
          </div>
          <div class="form-group mt-2">
            <label for="competitorStrengths">Key Strengths/Weaknesses:</label>
            <textarea class="form-control" id="competitorStrengths" name="strengths" rows="3"></textarea>
          </div>
          <div class="form-group mt-2">
            <label for="competitorStrategy">Our Strategy Against Them:</label>
            <textarea class="form-control" id="competitorStrategy" name="strategy" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" form="competitorForm" class="btn btn-primary">Add Competitor</button>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Add Tag Modal -->
<div class="modal fade" id="addTagModal" tabindex="-1" aria-labelledby="addTagModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addTagModalLabel">Add Tag</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="tagForm" action="{!url_for('add_tag', entity_type=entity_type, entity_id=entity_id) !}" method="POST">
          <div class="form-group">
            <label for="tagName">Tag Name:</label>
            <input type="text" class="form-control" id="tagName" name="name" required>
            <div class="form-text">Enter a new tag or select from existing tags.</div>
          </div>
          <div class="form-group mt-3">
            <label>Existing Tags:</label>
            <div class="existing-tags mt-2">
              {% for tag in all_tags %}
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="checkbox" id="tag{!tag.id !}" name="existing_tags" value="{!tag.id !}">
                <label class="form-check-label" for="tag{!tag.id !}">{!tag.name !}</label>
              </div>
              {% endfor %}
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="submit" form="tagForm" class="btn btn-primary">Add Tag</button>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Task Checkbox Toggle
    document.querySelectorAll('.task-checkbox').forEach(function(checkbox) {
      checkbox.addEventListener('change', function() {
        const taskId = this.value;
        const completed = this.checked;

        fetch("{!url_for('update_task_status') !}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{!csrf_token() !}'
          },
          body: JSON.stringify({
            task_id: taskId,
            completed: completed
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Update UI if needed
            const taskItem = checkbox.closest('.task-item');
            if (completed) {
              taskItem.classList.add('completed');
            } else {
              taskItem.classList.remove('completed');
            }
          }
        });
      });
    });

    // Action Item Checkbox Toggle
    document.querySelectorAll('.action-checkbox').forEach(function(checkbox) {
      checkbox.addEventListener('change', function() {
        const actionId = this.value;
        const completed = this.checked;

        fetch("{!url_for('update_action_status') !}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{!csrf_token() !}'
          },
          body: JSON.stringify({
            action_id: actionId,
            completed: completed
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Update UI
            const row = checkbox.closest('tr');
            if (completed) {
              row.classList.remove('table-danger');
              row.classList.add('table-success');
            } else {
              row.classList.remove('table-success');
              // Check if overdue
              if (row.classList.contains('is-overdue')) {
                row.classList.add('table-danger');
              }
            }
          }
        });
      });
    });

    // Notes Search and Filter
    const searchNotes = document.getElementById('searchNotes');
    const filterNoteType = document.getElementById('filterNoteType');
    const sortNotes = document.getElementById('sortNotes');

    function applyNotesFilters() {
      const searchTerm = searchNotes.value.toLowerCase();
      const filterType = filterNoteType.value;
      const sortOrder = sortNotes.value;

      // Get all note cards
      const notes = document.querySelectorAll('.note-card');

      // Filter and sort notes
      notes.forEach(function(note) {
        const noteContent = note.querySelector('.note-content').textContent.toLowerCase();
        const noteType = note.dataset.noteType;

        // Apply search and type filters
        let visible = true;

        if (searchTerm && !noteContent.includes(searchTerm)) {
          visible = false;
        }

        if (filterType && noteType !== filterType) {
          visible = false;
        }

        note.style.display = visible ? 'block' : 'none';
      });

      // Sort notes
      const notesList = document.querySelector('.notes-list');
      const notesArray = Array.from(notes).filter(note => note.style.display !== 'none');

      if (sortOrder === 'newest') {
        notesArray.sort((a, b) => {
          const dateA = new Date(a.querySelector('.note-date').textContent);
          const dateB = new Date(b.querySelector('.note-date').textContent);
          return dateB - dateA;
        });
      } else {
        notesArray.sort((a, b) => {
          const dateA = new Date(a.querySelector('.note-date').textContent);
          const dateB = new Date(b.querySelector('.note-date').textContent);
          return dateA - dateB;
        });
      }

      // Re-append sorted notes
      notesArray.forEach(note => notesList.appendChild(note));
    }

    if (searchNotes && filterNoteType && sortNotes) {
      searchNotes.addEventListener('input', applyNotesFilters);
      filterNoteType.addEventListener('change', applyNotesFilters);
      sortNotes.addEventListener('change', applyNotesFilters);
    }

    // Product calculations (for Opportunities)
    {% if entity_type == 'opportunity' %}
    const productSelect = document.getElementById('productSelect');
    const productQuantity = document.getElementById('productQuantity');
    const productPrice = document.getElementById('productPrice');
    const productDiscount = document.getElementById('productDiscount');
    const productTotal = document.getElementById('productTotal');

    function calculateProductTotal() {
      if (productQuantity && productPrice && productDiscount && productTotal) {
        const quantity = parseFloat(productQuantity.value) || 0;
        const price = parseFloat(productPrice.value) || 0;
        const discount = parseFloat(productDiscount.value) || 0;

        const total = quantity * price * (1 - discount / 100);
        productTotal.value = ' + total.toFixed(2);
      }
    }

    if (productSelect) {
      productSelect.addEventListener('change', function() {
        const option = this.options[this.selectedIndex];
        if (option && productPrice) {
          const price = option.getAttribute('data-price');
          productPrice.value = price || '';
          calculateProductTotal();
        }
      });
    }

    if (productQuantity && productPrice && productDiscount) {
      productQuantity.addEventListener('input', calculateProductTotal);
      productPrice.addEventListener('input', calculateProductTotal);
      productDiscount.addEventListener('input', calculateProductTotal);
    }

    // Deal stage change
    const dealStage = document.getElementById('dealStage');
    const lossReason = document.getElementById('lossReason');
    const lossReasonLabel = document.getElementById('lossReasonLabel');

    if (dealStage && lossReason && lossReasonLabel) {
      dealStage.addEventListener('change', function() {
        if (this.value === 'lost') {
          lossReason.style.display = 'block';
          lossReasonLabel.style.display = 'block';
        } else {
          lossReason.style.display = 'none';
          lossReasonLabel.style.display = 'none';
        }
      });
    }

    // Sales forecast chart
    const ctx = document.getElementById('forecastChart');
    if (ctx) {
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: {!forecast_labels|tojson !},
          datasets: [{
            label: 'Forecast',
            data: {!forecast_data|tojson !},
            borderColor: 'rgba(75, 192, 192, 1)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return ' + value;
                }
              }
            }
          }
        }
      });
    }
    {% endif %}

    // Range sliders with output display
    const probabilitySlider = document.getElementById('closeProbability');
    const probabilityOutput = document.getElementById('probabilityOutput');

    if (probabilitySlider && probabilityOutput) {
      probabilitySlider.addEventListener('input', function() {
        probabilityOutput.textContent = this.value + '%';
      });
    }

    const influenceSlider = document.getElementById('contactInfluence');
    const influenceOutput = document.getElementById('influenceOutput');

    if (influenceSlider && influenceOutput) {
      influenceSlider.addEventListener('input', function() {
        influenceOutput.textContent = this.value + '%';
      });
    }

    const threatSlider = document.getElementById('competitorThreat');
    const threatOutput = document.getElementById('threatOutput');

    if (threatSlider && threatOutput) {
      threatSlider.addEventListener('input', function() {
        threatOutput.textContent = this.value + '%';
      });
    }

    // Follow-up save button
    const saveFollowupBtn = document.querySelector('.save-followup');
    if (saveFollowupBtn) {
      saveFollowupBtn.addEventListener('click', function() {
        const followupDate = document.getElementById('followupDate').value;
        const followupType = document.getElementById('followupType').value;
        const followupNotes = document.getElementById('followupNotes').value;

        fetch("{!url_for('update_followup', entity_type=entity_type, entity_id=entity_id) !}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{!csrf_token() !}'
          },
          body: JSON.stringify({
            followup_date: followupDate,
            followup_type: followupType,
            followup_notes: followupNotes
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Show success notification
            const notification = document.createElement('div');
            notification.className = 'alert alert-success alert-dismissible fade show';
            notification.setAttribute('role', 'alert');
            notification.innerHTML = `
              Follow-up information saved successfully.
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;

            const followupSection = saveFollowupBtn.closest('.card-body');
            followupSection.insertBefore(notification, followupSection.firstChild);

            // Auto-dismiss after 3 seconds
            setTimeout(() => {
              notification.classList.remove('show');
              setTimeout(() => notification.remove(), 300);
            }, 3000);
          }
        });
      });
    }

    // Edit note functionality
    document.querySelectorAll('.edit-note').forEach(function(editBtn) {
      editBtn.addEventListener('click', function(e) {
        e.preventDefault();
        const noteId = this.dataset.noteId;
        const noteCard = this.closest('.note-card');
        const noteContent = noteCard.querySelector('.note-content').textContent.trim();

        // Replace note content with editable textarea
        noteCard.querySelector('.note-content').innerHTML = `
          <form class="note-edit-form">
            <textarea class="form-control" rows="4">${noteContent}</textarea>
            <div class="mt-2">
              <button type="submit" class="btn btn-sm btn-primary">Save</button>
              <button type="button" class="btn btn-sm btn-secondary cancel-edit">Cancel</button>
            </div>
          </form>
        `;

        // Handle save
        noteCard.querySelector('.note-edit-form').addEventListener('submit', function(e) {
          e.preventDefault();
          const updatedContent = this.querySelector('textarea').value;

          fetch("{!url_for('update_note') !}", {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': '{!csrf_token() !}'
            },
            body: JSON.stringify({
              note_id: noteId,
              content: updatedContent
            })
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              // Update UI
              noteCard.querySelector('.note-content').innerHTML = updatedContent.replace(/\n/g, '<br>');
            }
          });
        });

        // Handle cancel
        noteCard.querySelector('.cancel-edit').addEventListener('click', function() {
          noteCard.querySelector('.note-content').innerHTML = noteContent.replace(/\n/g, '<br>');
        });
      });
    });

    // Delete note functionality
    document.querySelectorAll('.delete-note').forEach(function(deleteBtn) {
      deleteBtn.addEventListener('click', function(e) {
        e.preventDefault();
        if (!confirm('Are you sure you want to delete this note?')) {
          return;
        }

        const noteId = this.dataset.noteId;
        const noteCard = this.closest('.note-card');

        fetch("{!url_for('delete_note') !}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{!csrf_token() !}'
          },
          body: JSON.stringify({
            note_id: noteId
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Remove from UI with animation
            noteCard.style.opacity = '0';
            setTimeout(() => {
              noteCard.style.height = '0';
              noteCard.style.margin = '0';
              noteCard.style.padding = '0';
              noteCard.style.overflow = 'hidden';
              setTimeout(() => noteCard.remove(), 300);
            }, 300);
          }
        });
      });
    });

    // Document tag removal
    document.querySelectorAll('.tag-remove').forEach(function(removeBtn) {
      removeBtn.addEventListener('click', function() {
        const tagElement = this.closest('.tag-item');
        const tagId = tagElement.dataset.tagId;

        fetch("{!url_for('remove_tag', entity_type=entity_type, entity_id=entity_id) !}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{!csrf_token() !}'
          },
          body: JSON.stringify({
            tag_id: tagId
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Remove from UI
            tagElement.remove();
          }
        });
      });
    });
  });
</script>
{% endblock %}