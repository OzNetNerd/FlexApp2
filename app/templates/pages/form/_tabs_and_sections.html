{#
  ------------------------------------------------------------------------------
  File: _tabs_and_sections.html
  Purpose:
    Dynamically groups form fields by their `tab` and `section` metadata,
    and renders them accordingly using tabbed navigation (if more than one tab)
    or as stacked sections (if only one tab or none).
  Inputs (expected in context):
    - fields : Dictionary with sections as keys, and a list of field objects
                    as values. Each field object should support:
        â€¢ name       : Field name.
        â€¢ label      : Field label.
        â€¢ type       : Field type.
        â€¢ tab        : Tab the field belongs to.
        â€¢ section    : Optional. Label for the section group within a tab.
  ------------------------------------------------------------------------------
#}

{# Create dictionary to organize fields by tab then by section #}
{% set tabs = {} %}
{% for section_name, section_fields in fields.items() %}
  {% for field in section_fields %}
    {% set tab = field.tab or 'Other' %}
    {% if tab not in tabs %}
      {% set _ = tabs.update({tab: {}}) %}
    {% endif %}
    {% if section_name not in tabs[tab] %}
      {% set _ = tabs[tab].update({section_name: []}) %}
    {% endif %}
    {% set _ = tabs[tab][section_name].append(field) %}
  {% endfor %}
{% endfor %}

{# Render the tabs #}
{% if tabs|length > 1 %}
  <div class="tab-content" id="formTabsContent">
    {% for tab, tab_sections in tabs.items() %}
      <div class="tab-pane fade {% if loop.first %}show active{% endif %}"
           id="tab-{{ tab | lower | replace(' ', '-') }}"
           role="tabpanel"
           aria-labelledby="tab-{{ tab | lower | replace(' ', '-') }}-tab">
        {% for section, section_fields in tab_sections.items() %}
          {% set _section = section %}
          {% set _section_fields = section_fields %}
          {% include 'pages/form/_section_card.html' %}
        {% endfor %}
      </div>
    {% endfor %}
  </div>
{% else %}
  {% for tab, tab_sections in tabs.items() %}
    {% for section, section_fields in tab_sections.items() %}
      {% set _section = section %}
      {% set _section_fields = section_fields %}
      {% include 'pages/form/_section_card.html' %}
    {% endfor %}
  {% endfor %}
{% endif %}

<!-- Logging for Tab and Section Structure -->
<script type="module">
  import log from "{{ url_for('static', filename='js/logger.js') }}";

  const tabSummary = {
    totalTabs: {{ tabs | length }},
    tabNames: {{ tabs.keys() | list | tojson | safe }},
    structure: [
      {% for tab, tab_sections in tabs.items() %}
        {
          tab: {{ tab | tojson | safe }},
          sectionCount: {{ tab_sections | length }},
          fieldCounts: {
            {% for section, section_fields in tab_sections.items() %}
              {{ section | tojson }}: {{ section_fields | length }}{% if not loop.last %},{% endif %}
            {% endfor %}
          }
        }{% if not loop.last %},{% endif %}
      {% endfor %}
    ]
  };

  log("info", "_tabs_and_sections.html", "render", "ðŸ§­ Tab/Section structure", tabSummary);
</script>
