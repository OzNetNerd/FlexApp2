{#
  ------------------------------------------------------------------------------
  File: _tabs_and_sections.html
  Purpose:
    Dynamically groups form fields by `tab` and `section` metadata,
    and renders them using Bootstrap-styled tabs (if more than one tab),
    or as stacked section cards (if only one tab or no tabs at all).

  Inputs (expected in context):
    - fields: Dict[str, List[Field]]
        A dictionary where each key is a section name and the value is a list
        of field objects. Each field object should include:
        â€¢ name    : str â€“ The field's internal name.
        â€¢ label   : str â€“ The human-readable label.
        â€¢ type    : str â€“ Field input type.
        â€¢ tab     : Optional[str] â€“ The tab it belongs to.
        â€¢ section : Optional[str] â€“ Grouping label inside a tab.

  Features:
    - Auto-groups fields by tab â†’ section â†’ fields
    - Renders tabbed layout if more than one tab is present
    - Falls back to stacked section cards if only one or no tabs
    - Each section is rendered using `_section_card.html`
    - Logs full tab/section structure to JS console

  Notes:
    - Requires `read_only` and `field` (macro namespace) to be available
    - Tabs are activated via Bootstrapâ€™s `data-bs-toggle="pill"`
  ------------------------------------------------------------------------------
#}

{# ðŸ§± Organize fields into nested tab > section > fields structure #}
{% set tabs = {} %}
{% for section_name, section_fields in fields.items() %}
  {% for field in section_fields %}
    {% set tab = field.tab or 'Other' %}
    {% if tab not in tabs %}
      {% set _ = tabs.update({tab: {}}) %}
    {% endif %}
    {% if section_name not in tabs[tab] %}
      {% set _ = tabs[tab].update({section_name: []}) %}
    {% endif %}
    {% set _ = tabs[tab][section_name].append(field) %}
  {% endfor %}
{% endfor %}

{# ðŸ§­ Render tabbed or stacked layout based on tab count #}
{% if tabs | length > 1 %}
  <div class="tab-content" id="formTabsContent">
    {% for tab, tab_sections in tabs.items() %}
      <div class="tab-pane fade {% if loop.first %}show active{% endif %}"
           id="tab-{{ tab | lower | replace(' ', '-') }}"
           role="tabpanel"
           aria-labelledby="tab-{{ tab | lower | replace(' ', '-') }}-tab">
        {% for section, section_fields in tab_sections.items() %}
          {% set _section = section %}
          {% set _section_fields = section_fields %}
          {% include 'pages/form/_section_card.html' %}
        {% endfor %}
      </div>
    {% endfor %}
  </div>
{% else %}
  {% for tab, tab_sections in tabs.items() %}
    {% for section, section_fields in tab_sections.items() %}
      {% set _section = section %}
      {% set _section_fields = section_fields %}
      {% include 'pages/form/_section_card.html' %}
    {% endfor %}
  {% endfor %}
{% endif %}

<!-- ðŸ§¾ Logging for Tabs and Sections Structure -->
<script type="module">
  import log from "{{ url_for('static', filename='js/logger.js') }}";

  const tabSummary = {
    totalTabs: {{ tabs | length }},
    tabNames: {{ tabs.keys() | list | tojson | safe }},
    structure: [
      {% for tab, tab_sections in tabs.items() %}
        {
          tab: {{ tab | tojson | safe }},
          sectionCount: {{ tab_sections | length }},
          fieldCounts: {
            {% for section, section_fields in tab_sections.items() %}
              {{ section | tojson }}: {{ section_fields | length }}{% if not loop.last %},{% endif %}
            {% endfor %}
          }
        }{% if not loop.last %},{% endif %}
      {% endfor %}
    ]
  };

  log("info", "_tabs_and_sections.html", "render", "ðŸ§­ Tab/Section structure", tabSummary);
</script>
