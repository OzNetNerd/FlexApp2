{% extends "layouts/base.html" %}
{% import "macros/buttons.html" as buttons %}
{% import "macros/sections.html" as sections %}
{% import "macros/cards.html" as cards %}

{% block title %}CRM Dashboard - Companies{% endblock %}

{% block head_extra %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<!-- Heading & subtext section -->
{{ sections.heading_section(
  heading_text='Company Accounts',
  subtext='Manage your customers and prospects efficiently'
) }}

<!-- Summary Section: Data -->
{% set large_card_data = [
    {
        "icon": "bi bi-building",
        "color": "text-primary",
        "title": "Active Accounts",
        "description": "With opportunities",
        "url": url_for('companies_bp.filtered_companies', has_opportunities='yes'),
        "badge": stats.with_opportunities
    },
    {
        "icon": "bi bi-plus-circle",
        "color": "text-success",
        "title": "Add Company",
        "description": "Create new account",
        "url": url_for('companies_bp.create'),
        "badge": None
    },
    {
        "icon": "bi bi-person-lines-fill",
        "color": "text-warning",
        "title": "With Contacts",
        "description": "View companies with contacts",
        "url": url_for('companies_bp.filtered_companies', has_contacts='yes'),
        "badge": None
    },
    {
        "icon": "bi bi-bar-chart",
        "color": "info",
        "title": "Analytics",
        "description": "Company insights",
        "url": url_for('companies_bp.statistics'),
        "badge": None
    }
] %}


<!-- Summary Section -->
{{ sections.large_cards_section(large_card_data) }}


<!-- Company Segments Section -->
{% set company_card_data = [
    {
        'title': 'High Engagement',
        'count': segments[0].count,
        'activity_count': '3+',
        'activity_label': 'opportunities',
        'percentage': segments[0].percentage,
        'icon': 'bi-star',
        'color_class': 'info',
        'button_label': 'View Companies',
        'button_url': url_for('companies_bp.filtered_companies', has_opportunities='yes')
    },
    {
        'title': 'Medium Engagement',
        'count': segments[1].count,
        'activity_count': '1-2',
        'activity_label': 'opportunities',
        'percentage': segments[1].percentage,
        'icon': 'bi-briefcase',
        'color_class': 'primary',
        'button_label': 'View Companies',
        'button_url': url_for('companies_bp.filtered_companies', has_opportunities='yes')
    },
    {
        'title': 'No Opportunities',
        'count': segments[2].count,
        'activity_count': '0',
        'activity_label': 'opportunities',
        'percentage': segments[2].percentage,
        'icon': 'bi-shop',
        'color_class': 'warning',
        'button_label': 'View Companies',
        'button_url': url_for('companies_bp.filtered_companies', has_opportunities='no')
    }
] %}

{{ sections.progress_bar_section(
    heading='Engagement Segments',
    href=url_for('companies_bp.filtered_companies'),
    button_text='View All Companies',
    card_data=company_card_data
) }}

<!-- Top Companies Section -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h2 class="section-card-heading">Top Companies</h2>
        <div>
          <a href="{{ url_for('companies_bp.filtered_companies', has_opportunities='yes') }}" class=" transparent-button me-2">
            <i class="bi bi-funnel"></i> Filter Companies
          </a>
          <a href="{{ url_for('companies_bp.create') }}" class="btn btn-sm btn-primary">Add Company</a>
        </div>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-hover emphasised-text">
            <thead class="table-light">
              <tr>
                <th scope="col" class="ps-4">Company Name</th>
                <th scope="col">Description</th>
                <th scope="col">Opportunities</th>
                <th scope="col">Contacts</th>
                <th scope="col">Notes</th>
                <th scope="col">Capabilities</th>
                <th scope="col" class="text-center">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for company, opportunity_count in top_companies %}
              <tr>
                <td class="ps-4">{{ company.name }}</td>
                <td>{{ company.description|truncate(50) if company.description else "" }}</td>
                <td>
                  <span class="badge bg-primary">{{ opportunity_count }}</span>
                </td>
                <td>
                  <span class="badge bg-info">{{ company.contacts|default([])|length }}</span>
                </td>
                <td>
                  {% if company.notes is defined and company.notes is not none %}
                    {% if company.notes is iterable and not company.notes is string %}
                      <span class="badge bg-secondary">{{ company.notes|length }}</span>
                    {% else %}
                      <span class="badge bg-secondary">1</span>
                    {% endif %}
                  {% else %}
                    <span class="badge bg-secondary">0</span>
                  {% endif %}
                </td>
                <td>
                  <span class="badge bg-success">{{ company.company_capabilities.count() }}</span>
                </td>
                <td class="text-center">
                  <a href="{{ url_for('companies_bp.view', entity_id=company.id) }}" class=" transparent-button me-1">View</a>
                  <a href="{{ url_for('companies_bp.edit', entity_id=company.id) }}" class="btn btn-sm btn-outline-secondary">Edit</a>
                </td>
              </tr>
              {% endfor %}
              {% if not top_companies %}
              <tr>
                <td colspan="7" class="text-center py-4">
                  <div class="text-muted">
                    <i class="bi bi-info-circle-fill fs-4 mb-2"></i>
                    <p>No companies with opportunities yet. Add a company?</p>
                  </div>
                </td>
              </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
      <div class="card-footer bg-white text-center">
        <a href="{{ url_for('companies_bp.filtered_companies') }}" class="text-decoration-none">
          View all {{ stats.total_companies }} companies
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Data Trends Chart -->
<div class="row mb-4">
  <div class="col-12">
    <div class="card border-0 shadow-sm">
      <div class="card-header bg-white">
        <h2 class="section-card-heading">Data Trends</h2>
      </div>
      <div class="card-body">
        <div style="height: 300px; position: relative;">
          <canvas id="dataChart"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script type="module">
  // Export data for the chart component
  window.chartData = {
    labels: {{ growth_data.labels|tojson }},
    newItems: {{ growth_data.new_companies|tojson }},
    totalItems: {{ growth_data.total_companies|tojson }}
  };
</script>
<script type="module" src="{{ url_for('static', filename='js/visuals/lineGraph.js') }}"></script>
{% endblock %}