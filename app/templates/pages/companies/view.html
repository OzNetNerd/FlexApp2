{% extends "layouts/base.html" %}

{% import 'macros/render_form_fields.html' as field_macros with context %}
{% import 'macros/tabs.html' as tab_macros with context %}
{% import 'macros/entity_macros.html' as entity_macros with context %}
{% import 'macros/render_notes.html' as notes_macros with context %}

{% set tabs = [
   {'tab_name': 'Notes'} if read_only else None,
   {'tab_name': 'About'},
   {'tab_name': 'System Info'} if read_only else None
] | reject('none') | list %}

{% block content %}
<div class="card border-0 shadow-sm" style="overflow: visible !important;">
 <!-- Card Header -->
 <div class="card-header bg-white py-3 pb-0" style="border: none;">
   <div class="d-flex justify-content-between align-items-center">
     <!-- Header Left - Heading -->
     <div class="d-flex align-items-center">
       <h3 class="h4 mb-0 text-primary me-3">
         {% if read_only %}
           <i class="fas fa-eye me-2"></i>
           View {{ model_name }}: <span class="text-info">{{ entity_name|default('') }}</span>
         {% else %}
           <i class="fas fa-edit me-2"></i>
           Edit {{ model_name }}: <span class="text-info">{{ entity_name|default('') }}</span>
         {% endif %}
       </h3>
     </div>

     <!-- Header Right - Action Buttons -->
     <div class="d-flex gap-2">
       <div class="d-flex justify-content-end align-items-center gap-2">
         {% if read_only %}
           <a href="{{ url_for(request.endpoint.rsplit('.', 1)[0] + '.create') }}"
               class="btn btn-primary fw-bold">
             <i class="fas fa-plus me-1"></i> Add
           </a>

           {% if entity is defined and entity.id %}
             <a href="{{ url_for(request.endpoint.rsplit('.', 1)[0] + '.edit', entity_id=entity.id) }}"
                 class="btn btn-warning text-dark fw-bold">
               <i class="fas fa-edit me-1"></i> Edit
             </a>
             <button type="button" id="delete-button" class="btn btn-danger">
               <i class="fas fa-trash me-1"></i> Delete
             </button>
           {% endif %}

           <a href="{{ url_for(request.endpoint.rsplit('.', 1)[0] + '.index') }}"
               class="btn btn-secondary">
             <i class="fas fa-arrow-left me-1"></i> Back
           </a>
         {% else %}
           {% if entity is defined and entity.id %}
             <a href="{{ url_for(request.endpoint.rsplit('.', 1)[0] + '.view', entity_id=entity.id) }}"
                class="btn btn-secondary">
               <i class="fas fa-times me-1"></i> Cancel
             </a>
             <button type="submit" class="btn btn-primary" form="main-form">
               <i class="fas fa-save me-1"></i> Update
             </button>
           {% else %}
             <a href="{{ url_for(request.endpoint.rsplit('.', 1)[0] + '.index') }}"
                class="btn btn-secondary">
               <i class="fas fa-times me-1"></i> Cancel
             </a>
             <button type="submit" class="btn btn-primary" form="main-form">
               <i class="fas fa-save me-1"></i> Save
             </button>
           {% endif %}
         {% endif %}
       </div>
     </div>
   </div>

   <!-- Tabs Navigation -->
   <div class="mt-3">
     {% if tabs %}
       <ul class="nav nav-tabs mb-3" id="formTabs" role="tablist">
         {%- for tab in tabs %}
           <li class="nav-item" role="presentation">
             <button class="nav-link {% if loop.first %}active{% endif %}"
                     id="tab-{{ tab.tab_name | lower | replace(' ', '-') }}-tab"
                     data-bs-toggle="tab"
                     data-bs-target="#tab-{{ tab.tab_name | lower | replace(' ', '-') }}"
                     type="button"
                     role="tab"
                     aria-controls="tab-{{ tab.tab_name | lower | replace(' ', '-') }}"
                     aria-selected="{% if loop.first %}true{% else %}false{% endif %}">
               {{ tab.tab_name }}
             </button>
           </li>
         {%- endfor %}
       </ul>
     {% endif %}
   </div>
 </div>

 <!-- Card Body - Main Content -->
 <div class="card-body pt-0 pb-0" style="overflow: visible !important;">
   <form method="post" action="{{ submit_url }}" id="main-form">
     {{ csrf_input }}
     <div class="tab-content" id="formTabsContent">
       {% if read_only %}
         <!-- Modified tab pane with extra classes -->
         <div class="tab-pane fade show active" id="tab-notes" role="tabpanel" aria-labelledby="tab-notes-tab">
           <div class="section-card card shadow-sm border-0 mb-4">
             <div class="section-header">
               <h5 class="section-heading">Notes</h5>
             </div>
             <div class="section-body">
               <!-- Direct search form implementation before including notes section -->
               <div class="row g-3">
                 <div class="col-12 mb-3">
                   <form id="notesSearchForm" class="mb-3">
                     <div class="input-group">
                       <input type="text" id="noteSearchInput" class="form-control" placeholder="Search notes...">
                       <button class="btn btn-outline-secondary" type="submit">
                         <i class="fas fa-search"></i> Search
                       </button>
                     </div>
                   </form>
                 </div>
                 {% include 'macros/_notes_section.html' %}
               </div>
             </div>
           </div>
         </div>
       {% endif %}

       {% call tab_macros.render_tab_section('about', 'About', active=not read_only, has_fade=false) %}
         {{ field_macros.render_field({
             "entry_name": "name",
             "label": "Company Name",
             "type": "text",
             "value": entity.name,
             "required": true,
             "options": []
         }, read_only=read_only) }}

         {{ field_macros.render_field({
             "entry_name": "description",
             "label": "Description",
             "type": "textarea",
             "value": entity.description,
             "required": false,
             "options": []
         }, read_only=read_only) }}
       {% endcall %}
     </div>
   </form>

   {% if not read_only %}
     {% include 'base/common/_footer_buttons.html' %}
   {% endif %}
 </div>
</div>

<!-- Move notes_section.js script outside tab container -->
<script type="module" src="/static/js/pages/notes_section.js"></script>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmationModal" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel" aria-hidden="true" data-bs-scroll="false">
 <div class="modal-dialog" role="document">
   <div class="modal-content">
     <div class="modal-header">
       <h5 class="modal-title" id="deleteModalLabel">Confirm Deletion</h5>
       <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
     </div>
     <div class="modal-body">
       Are you sure you want to delete this item? This action cannot be undone.
     </div>
     <div class="modal-footer">
       <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
       <button type="button" id="modalConfirmBtn" class="btn btn-danger">Confirm</button>
     </div>
   </div>
 </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
 window.headerButtonsData = {
   hasId: {{ 'true' if entity is defined and entity.id else 'false' }},
   readOnly: {{ 'true' if read_only else 'false' }},
   endpoint: "{{ request.endpoint }}",
   deleteUrl: "{{ url_for(request.endpoint.rsplit('.', 1)[0] + '.delete', entity_id=entity.id) if entity is defined and entity.id else '#' }}"
 };
</script>
<script type="module" src="/js/pages/create_view_edit.js"></script>
<script type="module" src="/js/pages/header_buttons.js"></script>

<!-- Tab initialization -->
<script>
 document.addEventListener('DOMContentLoaded', function() {
   // Get all tab elements
   const tabElements = document.querySelectorAll('[data-bs-toggle="tab"]');
   const tabContents = document.querySelectorAll('.tab-pane');

   // Make sure all tab panes have proper classes
   tabContents.forEach(pane => {
     // Ensure proper base classes are present
     pane.classList.add('fade');

     // If this is the active tab, make sure it's properly visible
     if (pane.classList.contains('active') ||
         document.querySelector(`[data-bs-target="#${pane.id}"]`)?.classList.contains('active')) {
       pane.classList.add('show');
     }
   });

   // Initialize Bootstrap tabs properly
   tabElements.forEach(tab => {
     tab.addEventListener('shown.bs.tab', function(event) {
       // When a tab is shown, ensure its content is visible
       const targetId = event.target.getAttribute('data-bs-target');
       const targetPane = document.querySelector(targetId);

       if (targetPane) {
         // Add show class to make content visible
         targetPane.classList.add('show');
       }
     });
   });

   // Ensure the initially active tab's content is visible
   const activeTab = document.querySelector('.nav-link.active');
   if (activeTab) {
     const targetId = activeTab.getAttribute('data-bs-target');
     const targetPane = document.querySelector(targetId);

     if (targetPane) {
       targetPane.classList.add('show', 'active');
     }
   }
 });
</script>
{% endblock %}