{% extends "layouts/base.html" %}
{% block title %}Add New Card{% endblock %}

{% block content %}
<div class="row">
  <div class="col-12">
    <h1 class="mb-4">Add New Card</h1>

    <div class="card shadow-sm">
      <div class="card-header bg-light">
        <h4 class="mb-0">Card Details</h4>
      </div>
      <div class="card-body">
        <form id="add-card-form" method="POST" action="{{ url_for('srs_bp.add_card') }}">
          {{ csrf_input }}

          <div class="mb-3">
            <label for="category" class="form-label fw-bold">Category</label>
            <div class="input-group">
              <select name="category" id="category" class="form-select">
                <option value="" selected disabled>-- Select category --</option>
                {% for category in categories %}
                <option value="{{ category.id }}">{{ category.name }}</option>
                {% endfor %}
              </select>
              <button type="button" class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#newCategoryModal">
                <i class="bi bi-plus-lg"></i> New
              </button>
            </div>
          </div>

          <div class="mb-3">
            <label for="question" class="form-label fw-bold">Question</label>
            <textarea
              name="question"
              id="question"
              class="form-control"
              rows="3"
              placeholder="Enter the question..."
              required
              autofocus></textarea>
          </div>

          <div class="mb-3">
            <label for="answer" class="form-label fw-bold">Answer</label>
            <textarea
              name="answer"
              id="answer"
              class="form-control"
              rows="4"
              placeholder="Enter the answer..."
              required></textarea>
          </div>

          <div class="mb-3">
            <label for="tags" class="form-label fw-bold">Tags</label>
            <input
              type="text"
              name="tags"
              id="tags"
              class="form-control"
              placeholder="Separate tags with commas (optional)">
            <div class="form-text">
              Tags help organize and search for cards.
            </div>
          </div>

          <div class="mb-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="review-immediately" name="review_immediately" checked>
              <label class="form-check-label" for="review-immediately">
                Add to today's review queue
              </label>
            </div>
          </div>

          <div class="d-flex justify-content-between">
            <a href="{{ url_for('srs_bp.dashboard') }}" class="btn btn-outline-secondary">
              <i class="bi bi-arrow-left"></i> Back to Dashboard
            </a>

            <div>
              <button type="submit" name="action" value="save" class="btn btn-primary">
                <i class="bi bi-save me-1"></i> Save
              </button>
              <button type="submit" name="action" value="save_add_another" class="btn btn-outline-primary ms-2">
                Save & Add Another
              </button>
            </div>
          </div>

          <div class="progress mt-3" style="height: 6px;">
            <div id="progress-bar" class="progress-bar bg-success" role="progressbar" style="width: 0%;"
                aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
        </form>
      </div>

      <div class="card-footer bg-white">
        <div class="row text-center small text-muted">
          <div class="col-4">
            <div id="total-cards" class="fw-bold">{{ stats.total_cards if stats else 0 }}</div>
            <div>Total Cards</div>
          </div>
          <div class="col-4">
            <div id="cards-due" class="fw-bold">{{ stats.cards_due if stats else 0 }}</div>
            <div>Due Today</div>
          </div>
          <div class="col-4">
            <div id="cards-reviewed" class="fw-bold">{{ stats.cards_reviewed_today if stats else 0 }}</div>
            <div>Reviewed Today</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- New Category Modal -->
<div class="modal fade" id="newCategoryModal" tabindex="-1" aria-labelledby="newCategoryModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="newCategoryModalLabel">Add New Category</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="category-form">
          <div class="mb-3">
            <label for="category-name" class="form-label">Category Name</label>
            <input type="text" class="form-control" id="category-name" required>
          </div>
          <div class="mb-3">
            <label for="category-color" class="form-label">Color (optional)</label>
            <input type="color" class="form-control form-control-color" id="category-color" value="#0d6efd" title="Choose category color">
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" id="save-category-btn">Save Category</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
  let formChanged = false;

  function updateProgressBar() {
    const form = document.getElementById('add-card-form');
    const requiredFields = form.querySelectorAll('[required]');
    const filledFields = Array.from(requiredFields).filter(field => field.value.trim() !== '');
    const percentage = (filledFields.length / requiredFields.length) * 100;

    const progressBar = document.getElementById('progress-bar');
    progressBar.style.width = percentage + '%';
    progressBar.setAttribute('aria-valuenow', percentage);
  }

  async function addNewCategory() {
    const categoryName = document.getElementById('category-name').value.trim();
    const categoryColor = document.getElementById('category-color').value;

    if (!categoryName) return;

    try {
      const response = await fetch('/api/srs/categories', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
        },
        body: JSON.stringify({
          name: categoryName,
          color: categoryColor
        })
      });

      if (!response.ok) {
        throw new Error('Failed to create category');
      }

      const data = await response.json();

      // Add new category to select dropdown
      const select = document.getElementById('category');
      const option = document.createElement('option');
      option.value = data.id;
      option.textContent = data.name;
      option.selected = true;
      select.appendChild(option);

      // Close modal
      const modal = bootstrap.Modal.getInstance(document.getElementById('newCategoryModal'));
      modal.hide();

      // Reset form
      document.getElementById('category-name').value = '';

      // Show confirmation
      alert('Category added successfully!');

    } catch (err) {
      console.error('Error creating category:', err);
      alert('Failed to create category. Please try again.');
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    // Track form changes
    const form = document.getElementById('add-card-form');
    const formInputs = form.querySelectorAll('input, textarea, select');

    formInputs.forEach(input => {
      input.addEventListener('input', () => {
        formChanged = true;
        updateProgressBar();
      });
    });

    // Save new category
    document.getElementById('save-category-btn').addEventListener('click', addNewCategory);

    // Initialize progress bar
    updateProgressBar();

    // Warn user if they try to leave with unsaved changes
    window.addEventListener('beforeunload', (e) => {
      if (formChanged) {
        e.preventDefault();
        e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
        return e.returnValue;
      }
    });

    // Mark form as unchanged when submitting
    form.addEventListener('submit', () => {
      formChanged = false;
    });
  });
</script>
{% endblock %}