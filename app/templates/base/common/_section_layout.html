{#
  ------------------------------------------------------------------------------
  File: _pills_nav_content.html
  Purpose:
    Renders a hierarchical form structure with tabs and sections based on field
    metadata. Fields are grouped first by tab, then by section within each tab,
    creating an organized multi-level form layout.

  Inputs (expected in context):
    - fields: List of field objects, each containing:
        - tab: Optional tab name (defaults to 'Other' if not specified)
        - section: Optional section name (defaults to 'General' if not specified)
        - name: Field name/identifier
    - read_only: Boolean flag indicating whether form is in read-only mode

  Structure:
    - Bootstrap tabs navigation for top-level organization
    - Card-based sections within each tab
    - Responsive grid layout for fields within each section
    - Special handling for 'crisp' field in read-only mode

  Processing logic:
    1. Groups fields by tab value
    2. For each tab, groups fields by section value
    3. Renders appropriate UI components based on grouping
    4. Logs generated structure for debugging

  Dependencies:
    - Requires macros/form_fields.html imports
    - Uses Bootstrap 5 tab components
    - Imports logging module for debugging
    - Special case inclusion for _crisp.html component
  ------------------------------------------------------------------------------
#}
{% import "macros/form_fields.html" as macros %}

{# Group fields by tab #}
{% set tabs = {} %}
{% for field in fields %}
  {% set tab = field.tab or 'Other' %}
  {% if tab not in tabs %}
    {% set _ = tabs.update({tab: []}) %}
  {% endif %}
  {% set _ = tabs[tab].append(field) %}
{% endfor %}

{# Render tab navigation #}
<ul class="nav nav-tabs mb-3" id="formTabs" role="tablist">
  {% for tab in tabs.keys() %}
    <li class="nav-item" role="presentation">
      <button class="nav-link {% if loop.first %}active{% endif %}"
              id="tab-{{ tab | lower | replace(' ', '-') }}-tab"
              data-bs-toggle="tab"
              data-bs-target="#tab-{{ tab | lower | replace(' ', '-') }}"
              type="button"
              role="tab">
        {{ tab }}
      </button>
    </li>
  {% endfor %}
</ul>

{# Render tab content panels #}
<div class="tab-content" id="formTabsContent">
  {% for tab, tab_fields in tabs.items() %}
    <div class="tab-pane fade {% if loop.first %}show active{% endif %}"
         id="tab-{{ tab | lower | replace(' ', '-') }}"
         role="tabpanel">
      {# Group tab fields by section #}
      {% set grouped_by_section = tab_fields | groupby('section') %}
      {% for section, section_fields in grouped_by_section %}
        <div class="card shadow-sm border-0 mb-4">
          <div class="card-header bg-white">
            <h5 class="h6 text-primary fw-semibold mb-0">
              {{ section or 'General' }}
            </h5>
          </div>
          <div class="card-body">
            <div class="row g-3">
              {% for field in section_fields %}
                {% if field.name == 'crisp' and read_only %}
                  {# Special case for crisp field in read-only mode #}
                  {% include 'pages/components/_crisp.html' with context %}
                {% else %}
                  {# Render standard field #}
                  {{ macros.field.render_field(field, read_only) }}
                {% endif %}
              {% endfor %}
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% endfor %}
</div>

<!-- Logger for Tabs and Sections -->
<script type="module">
  import log from "{{ url_for('static', filename='js/logger.js') }}";
  const tabs = {{ tabs.keys() | list | tojson | safe }};
  log("info", "_pills_nav_content.html", "tabs", "üß© Tabs generated from field definitions", tabs);
  {% for tab, tab_fields in tabs.items() %}
    const sections_{{ loop.index }} = {{ tab_fields | map(attribute='section') | list | unique | tojson | safe }};
    log("debug", "_pills_nav_content.html", "tabs", "üìÅ Sections under tab: {{ tab }}", sections_{{ loop.index }});
  {% endfor %}
</script>