<!-- START TEMPLATE: _section_layout.html -->

{# Import the field macros #}
{% import 'base/macros/render_form_fields.html' as field_macros with context %}

<!-- Store template information in data attributes -->
<div id="template-data"
     data-script-name="_section_layout.html"
     data-tabs-defined="{{ tabs is defined|tojson }}"
     data-read-only-defined="{{ read_only is defined|tojson }}">
</div>

{% if tabs %}
  <ul class="nav nav-tabs mb-3" id="formTabs" role="tablist"
      data-tab-names="{{ tabs|map(attribute='tab_name')|list|tojson }}">
    {%- for tab in tabs %}
      <li class="nav-item" role="presentation">
        <button class="nav-link {% if loop.first %}active{% endif %}"
                id="tab-{{ tab.tab_name | lower | replace(' ', '-') }}-tab"
                data-bs-toggle="tab"
                data-bs-target="#tab-{{ tab.tab_name | lower | replace(' ', '-') }}"
                type="button"
                role="tab"
                aria-controls="tab-{{ tab.tab_name | lower | replace(' ', '-') }}"
                aria-selected="{% if loop.first %}true{% else %}false{% endif %}">
          {{ tab.tab_name }}
        </button>
      </li>
    {%- endfor %}
  </ul>

  <div class="tab-content" id="formTabsContent">
    {%- for tab in tabs %}
      <div class="tab-pane fade {% if loop.first %}show active{% endif %}"
           id="tab-{{ tab.tab_name | lower | replace(' ', '-') }}"
           role="tabpanel"
           aria-labelledby="tab-{{ tab.tab_name | lower | replace(' ', '-') }}-tab"
           data-section-names="{{ tab.sections|map(attribute='section_name')|list|tojson }}">
        {%- for section in tab.sections %}
          <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-white">
              <h5 class="h6 text-primary fw-semibold mb-0">
                {{ section.section_name or 'General' }}
              </h5>
            </div>
            <div class="card-body">
              <div class="row g-3">
                {%- for field in section.entries %}
                  {%- if field.entry_name == 'crisp' and read_only %}
                    {% include 'components/_crisp.html' with context %}
                  {%- else %}
                    {{ field_macros.render_field({
                      "entry_name": field.entry_name,
                      "label": field.label,
                      "type": field.type,
                      "value": field.value,
                      "required": field.required,
                      "options": field.options
                    }, read_only=read_only) }}
                  {%- endif %}
                {%- endfor %}
              </div>
            </div>
          </div>
        {%- endfor %}
      </div>
    {%- endfor %}
  </div>

<script type="module">
  import log from '/static/js/logger.js';

  // Run logging after page load to avoid HTML entity issues
  document.addEventListener('DOMContentLoaded', () => {
    const templateData = document.getElementById('template-data');
    const scriptName = templateData.dataset.scriptName;

    // Log initialization info
    const functionName = 'template_init';
    const expected = ['tabs', 'read_only'];
    const received = [];
    const missing = [];

    if (JSON.parse(templateData.dataset.tabsDefined)) received.push('tabs'); else missing.push('tabs');
    if (JSON.parse(templateData.dataset.readOnlyDefined)) received.push('read_only'); else missing.push('read_only');

    log("info", scriptName, functionName, `üîç Expecting variables: ${expected.join(', ')}`);
    log("info", scriptName, functionName, `Received variables: ${received.join(', ') || 'None'}`);
    if (missing.length > 0) {
      log("warn", scriptName, functionName, `‚ùå Missing variables: ${missing.join(', ')}`);
    } else {
      log("info", scriptName, functionName, `‚úÖ All expected variables present`);
    }

    // Log tab render info if tabs exist
    const formTabs = document.getElementById('formTabs');
    if (formTabs) {
      const tabRenderFuncName = 'template_render';
      const tabNames = JSON.parse(formTabs.dataset.tabNames);
      log("info", scriptName, tabRenderFuncName, "üß© Tabs rendered:", tabNames);

      // Log sections for each tab
      document.querySelectorAll('.tab-pane').forEach((tabPane, index) => {
        const sectionNames = JSON.parse(tabPane.dataset.sectionNames);
        log("debug", scriptName, tabRenderFuncName, `üìÅ Sections in tab '${tabNames[index]}':`, sectionNames);
      });
    }
  });
</script>
{% endif %}

<!-- END TEMPLATE: _section_layout.html -->