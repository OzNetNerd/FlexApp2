<!-- START TEMPLATE: _section_layout.html -->
{# ------------------------------------------------------------------------------
  File: _section_layout.html | Purpose: Tab + section-based form layout
  Inputs:
    - fields: List of field objects (each may have optional properties:
      tab, section, name, etc.)
    - read_only: Boolean flag to determine if fields are rendered in read-only mode
  Structure:
    - Uses Bootstrap tabs for top-level grouping
    - Groups fields by tab and then by section within each tab
    - Each section is rendered in a card layout with a responsive grid for fields
  Dependencies:
    - A logger.js module for structured logging
------------------------------------------------------------------------------ #}

{% if fields %}
  {# Group fields by their tab property (default to "Other" if not provided) #}
  {%- set tabs = {} -%}
  {%- for field in fields -%}
    {%- set tab = field.tab or 'Other' -%}
    {%- if tab not in tabs -%}
      {%- set _ = tabs.update({tab: []}) -%}
    {%- endif -%}
    {%- set _ = tabs[tab].append(field) -%}
  {%- endfor %}

  <ul class="nav nav-tabs mb-3" id="formTabs" role="tablist">
    {%- for tab in tabs.keys() %}
      <li class="nav-item" role="presentation">
        <button class="nav-link {% if loop.first %}active{% endif %}"
                id="tab-{{ tab | lower | replace(' ', '-') }}-tab"
                data-bs-toggle="tab"
                data-bs-target="#tab-{{ tab | lower | replace(' ', '-') }}"
                type="button"
                role="tab">
          {{ tab }}
        </button>
      </li>
    {%- endfor %}
  </ul>

  <div class="tab-content" id="formTabsContent">
    {%- for tab, tab_fields in tabs.items() %}
      <div class="tab-pane fade {% if loop.first %}show active{% endif %}"
           id="tab-{{ tab | lower | replace(' ', '-') }}"
           role="tabpanel">
        {# Group fields within the current tab by their section property #}
        {%- set grouped_by_section = tab_fields | groupby('section') -%}
        {%- for section, section_fields in grouped_by_section %}
          <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-white">
              <h5 class="h6 text-primary fw-semibold mb-0">
                {{ section or 'General' }}
              </h5>
            </div>
            <div class="card-body">
              <div class="row g-3">
                {%- for field in section_fields %}
                  {%- if field.name == 'crisp' and read_only %}
                    {% include 'pages/components/_crisp.html' with context %}
                  {%- else %}
                    {{ macros.field.render_field(field, read_only) }}
                  {%- endif %}
                {%- endfor %}
              </div>
            </div>
          </div>
        {%- endfor %}
      </div>
    {%- endfor %}
  </div>

  <script type="module">
    import log from "{{ url_for('static', filename='js/logger.js') }}";

    const scriptName = '_section_layout.html';
    const functionName = 'template_render';

    const tabNames = {{ tabs.keys() | list | tojson | safe }};
    log("info", scriptName, functionName, "üß© Tabs generated from field definitions", tabNames);

    {%- for tab, tab_fields in tabs.items() %}
      const sections_{{ loop.index }} = {{ tab_fields | map(attribute='section') | list | unique | tojson | safe }};
      log("debug", scriptName, functionName, "üìÅ Sections under tab: {{ tab }}", sections_{{ loop.index }});
      log("debug", scriptName, functionName, "üßÆ Field count in tab '{{ tab }}':", {{ tab_fields | length }});
    {%- endfor %}

    if (tabNames.length === 0) {
      log("warn", scriptName, functionName, "‚ö†Ô∏è No tabs found. Fallback rendering may be needed.");
    } else {
      log("info", scriptName, functionName, "‚úÖ Tabs and sections rendered successfully.");
    }
  </script>
{% else %}
  <div class="alert alert-warning">
    No fields available for display.
  </div>
  <script type="module">
    import log from "{{ url_for('static', filename='js/logger.js') }}";
    log("warn", "_section_layout.html", "template_render", "‚ö†Ô∏è No fields passed into template.");
  </script>
{% endif %}
<!-- END TEMPLATE: _section_layout.html -->
