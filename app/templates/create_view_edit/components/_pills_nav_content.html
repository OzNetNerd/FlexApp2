{% import "macros/form_fields/render_field.html" as macros %}

<div class="tab-content">
  {% for tab in ui %}
    <div class="tab-pane fade {% if loop.first %}show active{% endif %}"
         id="tab-{{ tab.tab_name | lower | replace(' ', '-') }}"
         role="tabpanel"
         aria-labelledby="tab-{{ tab.tab_name | lower | replace(' ', '-') }}-tab">

      {% for section in tab.sections %}
        {% if section.section_name %}
          <h5 class="mt-3">{{ section.section_name }}</h5>
        {% endif %}

        <div class="row">
          {% if tab.tab_name == 'Mappings' and section.section_name == 'Mappings' and not read_only %}
            {# For edit mode, include the autocomplete template #}
            {% include 'create_view_edit/components/_autocomplete.html' %}
          {% elif tab.tab_name == 'Mappings' and section.section_name == 'Mappings' and read_only %}
            {# For read-only mode, display formatted mapping data #}
            <div class="col-12">
              <div class="row">
                {% for entry in section.entries %}
                  {% if entry.entry_name == 'users' %}
                    <div class="col-md-6">
                      <div class="card mb-4">
                        <div class="card-header bg-light">
                          <h5 class="mb-0">
                            <i class="fas fa-users me-2"></i>
                            {{ entry.label }}
                          </h5>
                        </div>
                        <div class="card-body p-0">
                          {% if entry.value %}
                            <div class="list-group list-group-flush">
                              {% for item in entry.value %}
                                <div class="list-group-item p-3">
                                  <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                      <div class="d-flex align-items-center">
                                        <span class="avatar-circle avatar-sm
                                        {% if item.relationship_type == 'Manages' %}bg-primary
                                        {% elif item.relationship_type == 'Works With' %}bg-success
                                        {% else %}bg-secondary{% endif %} me-3">
                                          <i class="fas fa-user-alt text-white"></i>
                                        </span>
                                        <strong>{{ item.entity_name }}</strong>
                                      </div>
                                      <div class="text-muted small mt-1">
                                        ID: {{ item.id }} • Entity ID: {{ item.entity_id }}
                                      </div>
                                    </div>
                                    <div>
                                      <span class="badge
                                      {% if item.relationship_type == 'Manages' %}bg-primary-soft text-primary
                                      {% elif item.relationship_type == 'Works With' %}bg-success-soft text-success
                                      {% else %}bg-secondary-soft text-secondary{% endif %} px-3 py-2">
                                        <i class="fas fa-
                                        {% if item.relationship_type == 'Manages' %}user-tie
                                        {% elif item.relationship_type == 'Works With' %}user-friends
                                        {% else %}link{% endif %} me-1"></i>
                                        {{ item.relationship_type }}
                                      </span>
                                    </div>
                                  </div>
                                </div>
                              {% endfor %}
                            </div>
                          {% else %}
                            <div class="p-4 text-center text-muted">
                              <i class="fas fa-info-circle me-2"></i> No users mappings found
                            </div>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                  {% elif entry.entry_name == 'companies' %}
                    <div class="col-md-6">
                      <div class="card mb-4">
                        <div class="card-header bg-light">
                          <h5 class="mb-0">
                            <i class="fas fa-building me-2"></i>
                            {{ entry.label }}
                          </h5>
                        </div>
                        <div class="card-body p-0">
                          {% if entry.value %}
                            <div class="list-group list-group-flush">
                              {% for item in entry.value %}
                                <div class="list-group-item p-3">
                                  <div class="d-flex justify-content-between align-items-center">
                                    <div>
                                      <div class="d-flex align-items-center">
                                        <span class="avatar-circle avatar-sm
                                        {% if item.relationship_type == 'Vendor' %}bg-purple
                                        {% else %}bg-secondary{% endif %} me-3">
                                          <i class="fas fa-building text-white"></i>
                                        </span>
                                        <strong>{{ item.entity_name }}</strong>
                                      </div>
                                      <div class="text-muted small mt-1">
                                        ID: {{ item.id }} • Entity ID: {{ item.entity_id }}
                                      </div>
                                    </div>
                                    <div>
                                      <span class="badge
                                      {% if item.relationship_type == 'Vendor' %}bg-purple-soft text-purple
                                      {% else %}bg-secondary-soft text-secondary{% endif %} px-3 py-2">
                                        <i class="fas fa-
                                        {% if item.relationship_type == 'Vendor' %}handshake
                                        {% else %}link{% endif %} me-1"></i>
                                        {{ item.relationship_type }}
                                      </span>
                                    </div>
                                  </div>
                                </div>
                              {% endfor %}
                            </div>
                          {% else %}
                            <div class="p-4 text-center text-muted">
                              <i class="fas fa-info-circle me-2"></i> No companies mappings found
                            </div>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                  {% endif %}
                {% endfor %}
              </div>
            </div>
          {% else %}
            {% for entry in section.entries %}
              {% set has_entry = entry is defined and entry %}
              {% set has_name = has_entry and entry.entry_name is defined %}
              {% set has_label = has_entry and entry.label is defined %}
              {% set skip_field = tab.tab_name == 'Mappings' and not read_only and has_name and (entry.entry_name == 'users' or entry.entry_name == 'companies') %}

              {% if has_entry and has_name and has_label and not skip_field %}
                {{ macros.render_field({
                  'name': entry.entry_name,
                  'label': entry.label,
                  'type': entry.type if entry.type is defined else 'text',
                  'required': entry.required if entry.required is defined else False,
                  'readonly': read_only or (entry.readonly if entry.readonly is defined else False) or (entry.type == 'readonly'),
                  'options': entry.options if entry.options is defined else None,
                  'value': entry.value if entry.value is defined else entry.default
                }) }}
              {% elif not skip_field %}
                <div class="col-md-6 mb-3">
                  <div class="alert alert-warning">
                    ⚠️ Skipped invalid entry in section "{{ section.section_name }}"
                  </div>
                </div>
                <script type="module">
                  import log from "{{ url_for('static', filename='js/logger.js') }}";
                  const message = `⚠️ Skipped invalid entry in section {{ section.section_name }} (Tab: {{ tab.tab_name }})`;
                  console.warn(message);
                  log("error", "_pills_nav_content.html", "render", message);
                </script>
              {% endif %}
            {% endfor %}
          {% endif %}
        </div>
      {% endfor %}
    </div>
  {% endfor %}
</div>

<style>
/* Custom styling for mapping cards */
.avatar-circle {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 36px;
  height: 36px;
  border-radius: 50%;
}

.avatar-sm {
  width: 32px;
  height: 32px;
  font-size: 0.8rem;
}

/* Soft background colors for badges */
.bg-primary-soft {
  background-color: rgba(13, 110, 253, 0.15);
}

.bg-success-soft {
  background-color: rgba(25, 135, 84, 0.15);
}

.bg-purple-soft {
  background-color: rgba(111, 66, 193, 0.15);
}

.bg-purple {
  background-color: #6f42c1;
}

.text-purple {
  color: #6f42c1;
}

.bg-secondary-soft {
  background-color: rgba(108, 117, 125, 0.15);
}
</style>