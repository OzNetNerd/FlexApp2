{% import "create_view_edit/macros/render_field.html" as macros %}

<script type="module">
  import log from "{{ url_for('static', filename='js/logger.js') }}";
  log("info", "tab_content.html", "init", "🚀 Tab content template loaded");
  log("debug", "tab_content.html", "config", "UI config exists: {{ ui is defined and ui is not none }}");
</script>

{% if ui %}
  <script type="module">
    import log from "{{ url_for('static', filename='js/logger.js') }}";
    log("debug", "tab_content.html", "tabs", "Number of tabs: {{ ui|length }}");
    {% for tab in ui %}
      log("debug", "tab_content.html", "tab_info", "Tab {{ loop.index }}: {{ tab.tab_name }}");
    {% endfor %}
  </script>

  <div class="tab-content">
    {% for tab in ui %}
      <script type="module">
        import log from "{{ url_for('static', filename='js/logger.js') }}";
        log("debug", "tab_content.html", "render_tab", "Rendering tab: {{ tab.tab_name }} ({{ loop.index }}/{{ ui|length }})");
        log("debug", "tab_content.html", "sections", "Tab has {{ tab.sections|length }} sections");
      </script>

      <div class="tab-pane fade {% if loop.first %}show active{% endif %}"
           id="tab-{{ tab.tab_name | lower | replace(' ', '-') }}"
           role="tabpanel"
           aria-labelledby="tab-{{ tab.tab_name | lower | replace(' ', '-') }}-tab">
        <script type="module">
          import log from "{{ url_for('static', filename='js/logger.js') }}";
          log("debug", "tab_content.html", "tab_state", "Tab {{ tab.tab_name }} initial state: {% if loop.first %}active{% else %}inactive{% endif %}");
        </script>

        {% for section in tab.sections %}
          <script type="module">
            import log from "{{ url_for('static', filename='js/logger.js') }}";
            log("debug", "tab_content.html", "render_section", "Rendering section: {{ section.section_name or 'Unnamed' }} ({{ loop.index }}/{{ tab.sections|length }})");
            {% if section.entries %}
              log("debug", "tab_content.html", "entries", "Section has {{ section.entries|length }} entries");
            {% else %}
              log("warn", "tab_content.html", "entries", "Section has no entries");
            {% endif %}
          </script>

          {% if section.section_name %}
            <h5 class="mt-3">{{ section.section_name }}</h5>
            <script type="module">
              import log from "{{ url_for('static', filename='js/logger.js') }}";
              log("debug", "tab_content.html", "section_header", "Section header rendered: {{ section.section_name }}");
            </script>
          {% endif %}

          <div class="row">
            {% if tab.tab_name == 'Mappings' and section.section_name == 'Mappings' %}
              <script type="module">
                import log from "{{ url_for('static', filename='js/logger.js') }}";
                log("info", "tab_content.html", "mappings", "Rendering special Mappings section");
                log("debug", "tab_content.html", "read_only", "Read-only mode: {{ read_only }}");
              </script>

              {% if not read_only %}
                <script type="module">
                  import log from "{{ url_for('static', filename='js/logger.js') }}";
                  log("debug", "tab_content.html", "autocomplete", "Including autocomplete component");
                </script>
                {% include 'base/components/_autocomplete.html' %}
              {% else %}
                <div class="col-12">
                  <div class="row">
                    <script type="module">
                      import log from "{{ url_for('static', filename='js/logger.js') }}";
                      log("debug", "tab_content.html", "mapping_entries", "Rendering read-only mapping entries");
                    </script>

                    {% for entry in section.entries %}
                      <script type="module">
                        import log from "{{ url_for('static', filename='js/logger.js') }}";
                        log("debug", "tab_content.html", "mapping_entry", "Processing entry: {{ entry.entry_name or 'Unnamed' }}");
                      </script>

                      {% if entry.entry_name == 'users' %}
                        <div class="col-md-6 mb-4">
                          <div class="card">
                            <div class="card-header bg-light fw-bold">
                              <i class="fas fa-users me-2"></i>{{ entry.label }}
                            </div>
                            <div class="card-body p-0">
                              <script type="module">
                                import log from "{{ url_for('static', filename='js/logger.js') }}";
                                log("debug", "tab_content.html", "users_card", "Users card header rendered");
                                log("debug", "tab_content.html", "users_data", "Has user values: {{ entry.value is defined and entry.value }}");
                                {% if entry.value %}
                                  log("debug", "tab_content.html", "users_count", "Number of users: {{ entry.value|length }}");
                                {% endif %}
                              </script>

                              {% if entry.value %}
                                <ul class="list-group list-group-flush">
                                  {% for item in entry.value %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                      <div>
                                        <strong>{{ item.entity_name }}</strong>
                                        <small class="text-muted ms-2">ID: {{ item.id }}</small>
                                      </div>
                                      <span class="badge bg-secondary">{{ item.relationship_type }}</span>
                                    </li>
                                    <script type="module">
                                      import log from "{{ url_for('static', filename='js/logger.js') }}";
                                      log("debug", "tab_content.html", "user_item", "Rendered user: {{ item.entity_name }} (ID: {{ item.id }})");
                                    </script>
                                  {% endfor %}
                                </ul>
                              {% else %}
                                <p class="p-3 text-muted mb-0">No related users</p>
                                <script type="module">
                                  import log from "{{ url_for('static', filename='js/logger.js') }}";
                                  log("debug", "tab_content.html", "users_empty", "No users to display");
                                </script>
                              {% endif %}
                            </div>
                          </div>
                        </div>
                      {% elif entry.entry_name == 'companies' %}
                        <div class="col-md-6 mb-4">
                          <div class="card">
                            <div class="card-header bg-light fw-bold">
                              <i class="fas fa-building me-2"></i>{{ entry.label }}
                            </div>
                            <div class="card-body p-0">
                              <script type="module">
                                import log from "{{ url_for('static', filename='js/logger.js') }}";
                                log("debug", "tab_content.html", "companies_card", "Companies card header rendered");
                                log("debug", "tab_content.html", "companies_data", "Has company values: {{ entry.value is defined and entry.value }}");
                                {% if entry.value %}
                                  log("debug", "tab_content.html", "companies_count", "Number of companies: {{ entry.value|length }}");
                                {% endif %}
                              </script>

                              {% if entry.value %}
                                <ul class="list-group list-group-flush">
                                  {% for item in entry.value %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                      <div>
                                        <strong>{{ item.entity_name }}</strong>
                                        <small class="text-muted ms-2">ID: {{ item.id }}</small>
                                      </div>
                                      <span class="badge bg-info">{{ item.relationship_type }}</span>
                                    </li>
                                    <script type="module">
                                      import log from "{{ url_for('static', filename='js/logger.js') }}";
                                      log("debug", "tab_content.html", "company_item", "Rendered company: {{ item.entity_name }} (ID: {{ item.id }})");
                                    </script>
                                  {% endfor %}
                                </ul>
                              {% else %}
                                <p class="p-3 text-muted mb-0">No related companies</p>
                                <script type="module">
                                  import log from "{{ url_for('static', filename='js/logger.js') }}";
                                  log("debug", "tab_content.html", "companies_empty", "No companies to display");
                                </script>
                              {% endif %}
                            </div>
                          </div>
                        </div>
                      {% else %}
                        <script type="module">
                          import log from "{{ url_for('static', filename='js/logger.js') }}";
                          log("debug", "tab_content.html", "mapping_skip", "Skipping unknown mapping entry type: {{ entry.entry_name }}");
                        </script>
                      {% endif %}
                    {% endfor %}
                  </div>
                </div>
              {% endif %}
            {% else %}
              <script type="module">
                import log from "{{ url_for('static', filename='js/logger.js') }}";
                log("debug", "tab_content.html", "standard_section", "Rendering standard section entries");
              </script>

              {% for entry in section.entries %}
                <script type="module">
                  import log from "{{ url_for('static', filename='js/logger.js') }}";
                  log("debug", "tab_content.html", "entry", "Processing standard entry: {{ entry.entry_name or 'Unnamed' }}");
                  log("debug", "tab_content.html", "entry_valid", "Entry valid: {{ entry.entry_name is defined and entry.entry_name and entry.label is defined and entry.label }}");
                </script>

                {% if entry.entry_name and entry.label %}
                  <script type="module">
                    import log from "{{ url_for('static', filename='js/logger.js') }}";
                    log("debug", "tab_content.html", "render_field", "Rendering field: {{ entry.entry_name }} (label: {{ entry.label }})");
                  </script>
                  {{ macros.render_field(entry, read_only=read_only) }}
                  <script type="module">
                    import log from "{{ url_for('static', filename='js/logger.js') }}";
                    log("debug", "tab_content.html", "field_rendered", "Field rendered: {{ entry.entry_name }}");
                  </script>
                {% else %}
                  <div class="col-12">
                    <div class="alert alert-warning">
                      ⚠️ Invalid entry in section "{{ section.section_name or 'Unknown' }}" – skipping.
                    </div>
                    <script type="module">
                      import log from "{{ url_for('static', filename='js/logger.js') }}";
                      log("warn", "tab_content.html", "invalid_entry", "Invalid entry in section '{{ section.section_name or 'Unknown' }}' - missing name or label");
                    </script>
                  </div>
                {% endif %}
              {% endfor %}
            {% endif %}
          </div>
          <script type="module">
            import log from "{{ url_for('static', filename='js/logger.js') }}";
            log("debug", "tab_content.html", "section_complete", "Section '{{ section.section_name or 'Unnamed' }}' rendering complete");
          </script>
        {% endfor %}
      </div>
      <script type="module">
        import log from "{{ url_for('static', filename='js/logger.js') }}";
        log("debug", "tab_content.html", "tab_complete", "Tab '{{ tab.tab_name }}' rendering complete");
      </script>
    {% endfor %}
  </div>

  <script type="module">
    import log from "{{ url_for('static', filename='js/logger.js') }}";
    log("info", "tab_content.html", "content_rendered", "All tabs content rendered successfully");

    // Check tab activation on DOM ready
    document.addEventListener('DOMContentLoaded', () => {
      const activeTab = document.querySelector('.tab-pane.active');
      if (activeTab) {
        log("info", "tab_content.html", "active_tab", "Active tab: " + activeTab.id);
      } else {
        log("error", "tab_content.html", "active_tab", "No active tab found");
      }

      // Verify tab content is visible
      const tabContent = document.querySelector('.tab-content');
      if (tabContent) {
        const computedStyle = window.getComputedStyle(tabContent);
        log("debug", "tab_content.html", "visibility",
            "Tab content display: " + computedStyle.display +
            ", visibility: " + computedStyle.visibility +
            ", dimensions: " + tabContent.offsetWidth + "x" + tabContent.offsetHeight);
      }
    });

    // Monitor tab switching
    document.addEventListener('shown.bs.tab', event => {
      log("info", "tab_content.html", "tab_switched", "Tab switched to: " + event.target.getAttribute('href'));
    });
  </script>
{% else %}
  <div class="alert alert-info">
    No UI configuration available to display.
  </div>
  <script type="module">
    import log from "{{ url_for('static', filename='js/logger.js') }}";
    log("warn", "tab_content.html", "no_ui", "No UI configuration available to display");
  </script>
{% endif %}

<script type="module">
  import log from "{{ url_for('static', filename='js/logger.js') }}";
  log("info", "tab_content.html", "final", "✅ Tab content template finished rendering");

  // Additional DOM verification
  document.addEventListener('DOMContentLoaded', () => {
    // Check for missing tab panes
    const tabPanes = document.querySelectorAll('.tab-pane');
    if (tabPanes.length === 0) {
      log("error", "tab_content.html", "validation", "No tab panes found in DOM");
    } else {
      log("debug", "tab_content.html", "validation", `Found ${tabPanes.length} tab panes in DOM`);
    }

    // Check for Bootstrap and event handlers
    if (typeof bootstrap === 'undefined') {
      log("error", "tab_content.html", "deps", "Bootstrap JS not loaded - tab switching may not work");
    } else {
      log("debug", "tab_content.html", "deps", "Bootstrap JS loaded successfully");
    }
  });
</script>