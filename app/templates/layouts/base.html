{# ------------------------------------------------------------------------------
  File: base.html | Purpose: Main application layout template
  Description:
    - Core layout template that consolidates the base structure, head section, and scripts
    - Provides the main structural blocks that other templates can extend
    - Handles common page elements like navbar and toast notifications

  Blocks:
    - title: Page title (defaults to "CRM")
    - head_extra: Additional head content
    - content: Main page content
    - footer: Page footer content
    - scripts_extra: Additional scripts to load at the end
------------------------------------------------------------------------------ #}

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}CRM{% endblock %}</title>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet" />

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />

    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.5/font/bootstrap-icons.min.css" rel="stylesheet" />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />

    <link href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-grid.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-theme-alpine.css" rel="stylesheet" />

    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}" />

    <script type="module">
      // ** Updated path for logger.js **
      import log from '{{ url_for('static', filename='js/core/logger.js') }}';
      try {
          // Use optional chaining in case self.title() fails (though unlikely in Jinja)
          const pageTitle = "{{ self.title()|escape|default('CRM') }}";
          log("info", "base.html", "head", `üéØ Page title set: ${pageTitle}`);
          log("debug", "base.html", "head", "üì¶ Head assets loaded");
      } catch (e) {
          console.error("Error logging from base.html head:", e);
      }
    </script>

    <script type="module">
      // ** Updated path for toasts.js **
      import { showToast } from "{{ url_for('static', filename='js/components/toasts.js') }}";
      // Expose to window for use by flash messages and other potential inline scripts
      window.showToast = showToast;
       console.debug("üçû Toast function exposed globally."); // Confirm it's set up
    </script>

    {% block head_extra %}{% endblock %}
  </head>

  <body>
    {%- with messages = get_flashed_messages(with_categories=true) %}
      {%- if messages %}
        <script>
          // Use a flag to ensure this runs only once per page load
          if (!window.flashMessagesShown) {
            window.flashMessagesShown = true; // Set flag
            document.addEventListener('DOMContentLoaded', function() {
              // Small delay to increase chance of showToast being ready
              // Note: toasts.js now initializes on DOMContentLoaded or immediately if ready
              // A very small delay might still be okay, or check window.showToast directly
              setTimeout(function() {
                if (typeof window.showToast === 'function') {
                  console.log("‚ö° Processing {{ messages|length }} flash messages...");
                  {% for category, message in messages %}
                    // Stagger message display slightly
                    setTimeout(function() {
                      const msg = {{ message | tojson | safe }};
                      const cat = {{ category | tojson | safe }} || 'info'; // Default category if none provided
                      window.showToast(msg, cat);
                      console.log(`üì¢ Flash shown (${cat}):`, msg);
                    }, {{ loop.index0 * 300 }});  // Stagger by 300ms
                  {% endfor %}
                } else {
                  console.error("Flash messages present, but window.showToast function not found.");
                   // Fallback: Alert messages if toast system failed
                   {% for category, message in messages %}
                     alert(`[{{ category }}] {{ message }}`);
                   {% endfor %}
                }
              }, 100); // Reduced initial delay, toast system should init quickly
            });
          }
        </script>
      {%- endif %}
    {%- endwith %}

    {%- if template_render_error %}
      <script>
         // Use a flag to ensure this runs only once
         if (!window.templateErrorShown) {
           window.templateErrorShown = true; // Set flag
           document.addEventListener('DOMContentLoaded', function() {
             setTimeout(function() { // Delay slightly
               if (typeof window.showToast === 'function') {
                 const errorMsg = {{ template_render_error | tojson | safe }};
                 window.showToast(`Template Render Error: ${errorMsg}`, "danger");
                 console.error("‚ùå Template render error:", errorMsg);
               } else {
                 console.error("Template render error occurred, but window.showToast function not found.");
                 alert("Template Render Error: " + {{ template_render_error | tojson | safe }}); // Fallback
               }
             }, 500); // Delay a bit longer for errors
           });
         }
      </script>v
    {%- endif %}

    {# Include Navbar (ensure path is correct relative to your templates dir) #}
    {% include 'layouts/navbar.html' with context %}

    <main class="py-3 py-md-4"> {# Responsive padding #}
      {# Use container-fluid for full width, or container for centered fixed-width #}
      <div class="container-fluid px-md-4"> {# Or class="container" #}
        {% block content %}{% endblock %}
      </div>
    </main>

    {% block footer %}{% endblock %}

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script type="module" src="{{ url_for('static', filename='js/main.js') }}"></script>

    {# --- Consider Conditional Loading for Page-Specific JS --- #}
    {# Instead of loading all these scripts on every page,
       use the 'scripts_extra' block in child templates
       or pass variables from Flask to decide which scripts to load. #}

    {# --- Loading page-specific JS like this is often inefficient --- #}
    {# These will likely cause errors if loaded on pages where their target elements don't exist. #}
    {# Best practice: Load these ONLY in the specific templates that need them, using the scripts_extra block #}
    {# --- Preferred method: Load page-specific scripts via block --- #}
    {% block scripts_extra %}
        {# Example: In 'tasks/create.html', you would extend this block:
           {% block scripts_extra %}
             {{ super() }}
             <script type="module" src="{{ url_for('static', filename='js/pages/tasks/create.js') }}"></script>
           {% endblock %}
        #}
    {% endblock %}

  </body>
</html>