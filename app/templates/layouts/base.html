<!-- START TEMPLATE: base.html -->
{# ------------------------------------------------------------------------------
  File: base.html | Purpose: Main application layout template
  Description:
    - Core layout template that consolidates the base structure, head section, and scripts
    - Provides the main structural blocks that other templates can extend
    - Handles common page elements like navbar and toast notifications

  Blocks:
    - title: Page title (defaults to "CRM")
    - head_extra: Additional head content
    - content: Main page content
    - footer: Page footer content
    - scripts_extra: Additional scripts to load at the end
------------------------------------------------------------------------------ #}

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}CRM{% endblock %}</title>
    
    <!-- Google Fonts: Poppins -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet" />
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    
    <!-- Bootstrap Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.5/font/bootstrap-icons.min.css" rel="stylesheet" />
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
    
    <!-- AG Grid Styles -->
    <link href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-grid.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-theme-alpine.css" rel="stylesheet" />
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/modes.css') }}" />

    <!-- Head Debug Logger -->
    <script type="module">
      import log from '/static/js/logger.js';
      log("info", "base.html", "head", "üéØ Page title set", "{{ self.title() }}");
      log("debug", "base.html", "head", "üì¶ Head assets loaded");
    </script>
    
    <!-- Toast Module Loader: Always load toasts.js and expose showToast globally -->
    <script type="module">
      import { showToast } from "{{ url_for('static', filename='js/toasts.js') }}";
      window.showToast = showToast;
    </script>
    
    {% block head_extra %}{% endblock %}
  </head>
  
  <body>
    <!-- Toast container -->
    <div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 9999; display: flex; flex-direction: column-reverse; max-height: 80vh; overflow-y: auto;">
      <!-- Template toast (hidden) -->
      <div id="liveToast" style="display: none;"></div>
    </div>

    <!-- Add flash messages -->
    {%- with messages = get_flashed_messages(with_categories=true) %}
      {%- if messages %}
        <script>
          document.addEventListener('DOMContentLoaded', function() {
            // Give the toast system time to initialize
            setTimeout(function() {
              {% for category, message in messages %}
                // Add delay between messages
                setTimeout(function() {
                  if (typeof window.showToast === 'function') {
                    window.showToast({{ message | tojson | safe }}, {{ category | tojson | safe }});
                    console.log("üì¢ Flash message shown", {
                      category: {{ category | tojson | safe }},
                      message: {{ message | tojson | safe }}
                    });
                  } else {
                    console.error("Toast function not available");
                  }
                }, {{ loop.index * 500 }});  // 500ms between toasts
              {% endfor %}
            }, 300);  // Wait for initialization
          });
        </script>
      {%- endif %}
    {%- endwith %}

    <!-- Add template error if present -->
    {%- if template_render_error %}
      <script>
        document.addEventListener('DOMContentLoaded', function() {
          // Give the toast system time to initialize
          setTimeout(function() {
            if (typeof window.showToast === 'function') {
              window.showToast({{ template_render_error | tojson | safe }}, "danger");
              console.log("‚ùå Template render error", {{ template_render_error | tojson | safe }});
            } else {
              console.error("Toast function not available");
            }
          }, 800);  // Wait longer for template errors
        });
      </script>
    {%- endif %}
    
    {% include 'components/navbar.html' %}

    <main class="py-4">
      <div class="container">
        {% block content %}{% endblock %}
      </div>
    </main>

    {% block footer %}{% endblock %}

    <!-- Bootstrap Bundle with Popper (includes both Bootstrap JS and the Popper dependency) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Core application scripts -->
    <script type="module" src="{{ url_for('static', filename='js/main.js') }}"></script>
    
    <!-- Autocomplete functionality -->
    <script type="module" src="{{ url_for('static', filename='js/autoComplete.js') }}"></script>

    <!-- Load external JavaScript for base template logging and DOM verification -->
    <script type="module" src="{{ url_for('static', filename='js/pages/base_page.js') }}"></script>

    <!-- Task page JavaScript (will only load on task pages) -->
    <script type="module" src="{{ url_for('static', filename='js/pages/create_view_edit_task.js') }}"></script>
    
    {% block scripts_extra %}{% endblock %}
  </body>
</html>
<!-- END TEMPLATE: base.html -->