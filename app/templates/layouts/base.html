{# ------------------------------------------------------------------------------
  File: base.html | Purpose: Main application layout template
  Description:
    - Core layout template that consolidates the base structure, head section, and scripts
    - Provides the main structural blocks that other templates can extend
    - Handles common page elements like navbar, sidebar and toast notifications

  Blocks:
    - title: Page title (defaults to "CRM")
    - head_extra: Additional head content
    - content: Main page content
    - footer: Page footer content
    - scripts_extra: Additional scripts to load at the end
------------------------------------------------------------------------------ #}

<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{% block title %}CRM{% endblock %}</title>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.5/font/bootstrap-icons.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
    <link href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-grid.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-theme-alpine.css" rel="stylesheet" />
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}" />

    <script type="module">
      import log from '{{ url_for('static', filename='js/core/logger.js') }}';
      try {
          const pageTitle = "{{ self.title()|escape|default('CRM') }}";
          log("info", "base.html", "head", `üéØ Page title set: ${pageTitle}`);
          log("debug", "base.html", "head", "üì¶ Head assets loaded");
      } catch (e) {
          console.error("Error logging from base.html head:", e);
      }
    </script>

    <script type="module">
      import { showToast } from "{{ url_for('static', filename='js/components/toasts.js') }}";
      window.showToast = showToast;
      console.debug("üçû Toast function exposed globally.");
    </script>

    <style>
      /* Base layout for sidebar and main content */
      body {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        transition: all 0.3s ease;
      }

      .main-content-wrapper {
        display: flex;
        flex: 1;
      }

      .main-content {
        flex: 1;
        transition: margin-left 0.3s ease;
        width: 100%;
      }

      /* Sidebar adjustments */
      .sidebar-collapsed .main-content {
        margin-left: 60px;
      }

      .main-content {
        margin-left: 250px;
      }

      /* Responsive layout */
      @media (max-width: 991.98px) {
        .main-content {
          margin-left: 0;
        }

        .sidebar-collapsed .main-content {
          margin-left: 0;
        }
      }

      /* Dark theme support */
      [data-theme="dark"] {
        color-scheme: dark;
        --bs-body-color: #e9ecef;
        --bs-body-bg: #212529;
      }

      [data-theme="dark"] .bg-white {
        background-color: #212529 !important;
      }

      [data-theme="dark"] .navbar,
      [data-theme="dark"] .sidebar {
        background-color: #212529;
        border-color: #343a40;
      }

      [data-theme="dark"] .navbar-brand,
      [data-theme="dark"] .nav-link,
      [data-theme="dark"] .sidebar-link {
        color: #e9ecef;
      }
    </style>

    {% block head_extra %}{% endblock %}
  </head>

  <body>
    {%- with messages = get_flashed_messages(with_categories=true) %}
      {%- if messages %}
        <script>
          if (!window.flashMessagesShown) {
            window.flashMessagesShown = true;
            document.addEventListener('DOMContentLoaded', function() {
              setTimeout(function() {
                if (typeof window.showToast === 'function') {
                  console.log("‚ö° Processing {{ messages|length }} flash messages...");
                  {% for category, message in messages %}
                    setTimeout(function() {
                      const msg = {{ message | tojson | safe }};
                      const cat = {{ category | tojson | safe }} || 'info';
                      window.showToast(msg, cat);
                      console.log(`üì¢ Flash shown (${cat}):`, msg);
                    }, {{ loop.index0 * 300 }});
                  {% endfor %}
                } else {
                  console.error("Flash messages present, but window.showToast function not found.");
                   {% for category, message in messages %}
                     alert(`[{{ category }}] {{ message }}`);
                   {% endfor %}
                }
              }, 100);
            });
          }
        </script>
      {%- endif %}
    {%- endwith %}

    {%- if template_render_error %}
      <script>
         if (!window.templateErrorShown) {
           window.templateErrorShown = true;
           document.addEventListener('DOMContentLoaded', function() {
             setTimeout(function() {
               if (typeof window.showToast === 'function') {
                 const errorMsg = {{ template_render_error | tojson | safe }};
                 window.showToast(`Template Render Error: ${errorMsg}`, "danger");
                 console.error("‚ùå Template render error:", errorMsg);
               } else {
                 console.error("Template render error occurred, but window.showToast function not found.");
                 alert("Template Render Error: " + {{ template_render_error | tojson | safe }});
               }
             }, 500);
           });
         }
      </script>
    {%- endif %}

    {# Include Sidebar (must come before main content) #}
    {% include 'menus/sidebar.html' with context %}

    <div class="main-content-wrapper">
      <div class="main-content">
        {# Include Navbar #}
        {% include 'menus/navbar.html' with context %}

        <main class="py-3 py-md-4">
          <div class="container-fluid px-md-4">
            {% block content %}{% endblock %}
          </div>
        </main>

        {% block footer %}{% endblock %}
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module" src="{{ url_for('static', filename='js/main.js') }}"></script>

    <script>
      document.addEventListener('DOMContentLoaded', () => {
        // Check for theme preference in localStorage
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
          document.body.setAttribute('data-theme', savedTheme);
          console.debug(`Applied saved theme: ${savedTheme}`);
        }

        // Theme toggle handler for both navbar and sidebar
        window.toggleTheme = function() {
          const currentTheme = document.body.getAttribute('data-theme');
          const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
          document.body.setAttribute('data-theme', newTheme);
          localStorage.setItem('theme', newTheme);
          console.info(`Theme switched to: ${newTheme}`);
        }

        // Add event listener to theme toggle button
        const themeToggleBtn = document.getElementById('themeToggleBtn');
        if (themeToggleBtn) {
          themeToggleBtn.addEventListener('click', window.toggleTheme);
          console.debug("Theme toggle button initialized");
        }
      });
    </script>

    {% block scripts_extra %}{% endblock %}
  </body>
</html>