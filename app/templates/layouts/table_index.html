{# ------------------------------------------------------------------------------
  File: table_index.html | Purpose: Partial template for entity table index
  Description:
    - Displays entity listing with AG Grid
    - Includes filtering, column selector, and global search (inline)
------------------------------------------------------------------------------ #}

{# Filter panel macro #}
{% macro render_filter_panel(filters) %}
<div class="filter-panel card border-0 shadow-sm mb-4">
  <div class="card-header bg-light d-flex justify-content-between align-items-center py-2">
    <h5 class="mb-0 fs-6 fw-semibold">Filters</h5>
    <button class="btn btn-sm btn-outline-secondary" id="clearAllFilters" type="button">
      <i class="fas fa-times me-1"></i> Clear All
    </button>
  </div>
  <div class="card-body p-3">
    <form id="tableFilters" class="row g-3" method="GET" action="">
      {% for filter in filters %}
        <div class="col-md-{{ filter.width|default(6) }} col-lg-{{ filter.lg_width|default(filter.width|default(4)) }}">
          <label for="filter_{{ filter.field }}" class="form-label fw-medium small mb-1">{{ filter.label }}</label>
          {% if filter.type == 'select' %}
            <select class="form-select form-select-sm" id="filter_{{ filter.field }}" name="{{ filter.field }}" data-filter-type="{{ filter.filterType|default('equals') }}">
              <option value="">-- All --</option>
              {% for option in filter.options %}
                {% if option is mapping %}
                  <option value="{{ option.value }}" {% if request.args.get(filter.field) == option.value|string %}selected{% endif %}>{{ option.label }}</option>
                {% else %}
                  <option value="{{ option }}" {% if request.args.get(filter.field) == option|string %}selected{% endif %}>{{ option }}</option>
                {% endif %}
              {% endfor %}
            </select>
          {% elif filter.type == 'date' %}
            <div class="input-group input-group-sm">
              <input type="date" class="form-control" id="filter_{{ filter.field }}_start" name="{{ filter.field }}_start" data-filter-type="greaterThanOrEqual" value="{{ request.args.get(filter.field + '_start', '') }}">
              <span class="input-group-text">to</span>
              <input type="date" class="form-control" id="filter_{{ filter.field }}_end" name="{{ filter.field }}_end" data-filter-type="lessThanOrEqual" value="{{ request.args.get(filter.field + '_end', '') }}">
            </div>
          {% elif filter.type == 'number' %}
            <div class="input-group input-group-sm">
              <input type="number" class="form-control" id="filter_{{ filter.field }}_min" name="{{ filter.field }}_min" placeholder="Min" data-filter-type="greaterThanOrEqual" value="{{ request.args.get(filter.field + '_min', '') }}">
              <span class="input-group-text">to</span>
              <input type="number" class="form-control" id="filter_{{ filter.field }}_max" name="{{ filter.field }}_max" placeholder="Max" data-filter-type="lessThanOrEqual" value="{{ request.args.get(filter.field + '_max', '') }}">
            </div>
          {% else %}
            <input type="{{ filter.type|default('text') }}" class="form-control form-control-sm" id="filter_{{ filter.field }}" name="{{ filter.field }}" placeholder="{{ filter.placeholder|default(filter.label) }}" data-filter-type="{{ filter.filterType|default('contains') }}" value="{{ request.args.get(filter.field, '') }}">
          {% endif %}
        </div>
      {% endfor %}
      <div class="col-12 mt-3">
        <button type="submit" class="btn btn-sm btn-primary"><i class="fas fa-filter me-1"></i> Apply Filters</button>
        <a href="{{ request.path }}" class="btn btn-sm btn-outline-secondary"><i class="fas fa-undo me-1"></i> Reset Filters</a>
      </div>
    </form>
  </div>
</div>
{% endmacro %}

{# Main table container #}
<div class="container-fluid mt-3">
  <div class="row mb-3">
    <div class="col-12 d-flex align-items-center">
      {% if show_heading|default(true) %}
        <h1 class="h3 mb-0 me-auto">{{ entity_title|default('Items') }}</h1>
      {% endif %}
      <div class="d-flex align-items-center">
        <div class="input-group input-group-sm me-2" style="width: 150px;">
          <span class="input-group-text"><i class="fas fa-search"></i></span>
          <input type="text" id="globalSearch" class="form-control" placeholder="Search...">
        </div>
        {% block action_buttons %}
          <a href="{{ url_for(entity_base_route + '.create') }}" class="btn btn-sm btn-primary">
            <i class="fas fa-plus me-1"></i> Add {{ entity_name|default('Item') }}
          </a>
        {% endblock %}
        {% block extra_action_buttons %}{% endblock %}
        <!-- Column selector button -->
        <div class="dropdown ms-2">
          <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="columnSelectorBtn" data-bs-toggle="dropdown" aria-expanded="false">
            <i class="fas fa-columns me-1"></i> Columns
          </button>
          <div class="dropdown-menu p-3" style="width: 250px;" aria-labelledby="columnSelectorBtn">
            <div class="d-flex justify-content-between mb-2">
              <button id="selectAllColumns" class="btn btn-sm btn-outline-primary">Select All</button>
              <button id="clearAllColumns" class="btn btn-sm btn-outline-secondary">Clear All</button>
            </div>
            <div id="columnSelectorItems" class="mt-2">
              <!-- Column checkboxes will be added here dynamically -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  {# Render filter panel if filters are defined #}
  {% if filters is defined and filters|length > 0 %}
    {{ render_filter_panel(filters) }}
  {% endif %}

  <div class="row">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        {% if show_card_header|default(true) %}
          <div class="card-header bg-light py-2 border-bottom d-flex flex-wrap align-items-center">
            {% if show_card_title|default(false) %}
              <h5 class="mb-0 me-3 fs-6 fw-semibold">{{ entity_title|default('Items') }} List</h5>
            {% endif %}
            <div class="ms-auto d-flex gap-2">
              {% block table_actions %}{% endblock %}
            </div>
          </div>
        {% endif %}

        <div class="card-body p-0">
          <div id="table-container"
               class="ag-theme-alpine"
               data-api-url="{{ api_url|default('') }}"
               data-entity-name="{{ entity_name|default('item') }}"
               style="height: 600px; width: 100%;">
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- AG Grid CDN script -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/ag-grid/31.0.1/ag-grid-community.min.js"></script>

<!-- Load your combined table module -->
<script type="module" src="{{ url_for('static', filename='js/components/table.js') }}"></script>

<!-- Error monitoring -->
<script type="module">
  import log from '/static/js/core/logger.js';

  window.addEventListener('error', function(e) {
    log("error", "global", "uncaught", `Script error: ${e.message} in ${e.filename} line ${e.lineno}`);
    const container = document.querySelector('#table-container');
    if (container) {
      container.innerHTML = `<div class="alert alert-danger m-3">Error loading table: ${e.message}</div>`;
    }
  });
</script>