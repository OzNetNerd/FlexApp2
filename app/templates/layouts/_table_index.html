{# ------------------------------------------------------------------------------
  File: _table_index.html | Purpose: Partial template for entity table index
  Description:
    - Defines a consistent structure for displaying table-based entity listings
    - Incorporates table rendering functionality as a reusable component
    - Provides blocks for entity-specific customization
    - Supports sorting, filtering, and pagination

  Context Variables:
    - entity_title: The display name of the entity type (e.g., "Companies")
    - entity_name: Singular entity name for button labels (e.g., "Company")
    - entity_base_route: Base route name for the entity (e.g., "companies_bp")
    - api_url: API endpoint for loading the table data
    - default_sort: Default sort field (defaults to "name")
    - additional_filters: Optional additional filters to apply
    - show_heading: Whether to show the main h1 heading (defaults to true)
    - show_card_title: Whether to show the card title h3 heading (defaults to false)
------------------------------------------------------------------------------ #}

{# Define macros #}
{% macro render_filter_panel(filters) %}
<div class="filter-panel card border-0 shadow-sm mb-4">
  <div class="card-header bg-white d-flex justify-content-between align-items-center">
    <h5 class="mb-0">Filters</h5>
    <button class="btn btn-sm btn-outline-secondary" id="clearAllFilters">
      <i class="fas fa-times me-1"></i> Clear All
    </button>
  </div>
  <div class="card-body">
    <form id="tableFilters" class="row g-3">
      {% for filter in filters %}
        <div class="col-md-{{ filter.width|default(6) }}">
          <label for="filter_{{ filter.field }}" class="form-label">{{ filter.label }}</label>

          {% if filter.type == 'select' %}
            <select class="form-select" id="filter_{{ filter.field }}" name="{{ filter.field }}"
                    data-filter-type="{{ filter.filterType|default('equals') }}">
              <option value="">-- All --</option>
              {% for option in filter.options %}
                {% if option is mapping %}
                  <option value="{{ option.value }}">{{ option.label }}</option>
                {% else %}
                  <option value="{{ option }}">{{ option }}</option>
                {% endif %}
              {% endfor %}
            </select>

          {% elif filter.type == 'date' %}
            <div class="input-group">
              <input type="date" class="form-control" id="filter_{{ filter.field }}_from"
                     name="{{ filter.field }}_from" data-filter-type="greaterThanOrEqual">
              <span class="input-group-text">to</span>
              <input type="date" class="form-control" id="filter_{{ filter.field }}_to"
                     name="{{ filter.field }}_to" data-filter-type="lessThanOrEqual">
            </div>

          {% elif filter.type == 'number' %}
            <div class="input-group">
              <input type="number" class="form-control" id="filter_{{ filter.field }}_from"
                     name="{{ filter.field }}_from" placeholder="Min" data-filter-type="greaterThanOrEqual">
              <span class="input-group-text">to</span>
              <input type="number" class="form-control" id="filter_{{ filter.field }}_to"
                     name="{{ filter.field }}_to" placeholder="Max" data-filter-type="lessThanOrEqual">
            </div>

          {% else %}
            <input type="{{ filter.type|default('text') }}" class="form-control"
                   id="filter_{{ filter.field }}" name="{{ filter.field }}"
                   placeholder="{{ filter.placeholder|default('') }}"
                   data-filter-type="{{ filter.filterType|default('contains') }}">
          {% endif %}
        </div>
      {% endfor %}

      <div class="col-12">
        <button type="submit" class="btn btn-primary">
          <i class="fas fa-filter me-1"></i> Apply Filters
        </button>
        <button type="reset" class="btn btn-outline-secondary">
          <i class="fas fa-undo me-1"></i> Reset
        </button>
      </div>
    </form>
  </div>
</div>
{% endmacro %}

{# Main content for the partial #}
<div class="container-fluid">
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        {% if show_heading|default(true) %}
        <h1 class="h3">{{ entity_title|default('Items') }}</h1>
        {% else %}
        <div></div> {# Empty div to maintain flex layout #}
        {% endif %}

        <div class="action-buttons">
          {% block action_buttons %}
          <a href="{{ url_for(entity_base_route + '.create') }}" class="btn btn-primary">
            <i class="fas fa-plus me-1"></i> Add {{ entity_name|default('Item') }}
          </a>
          {% endblock %}
        </div>
      </div>
    </div>
  </div>

  {% if filters is defined %}
    {{ render_filter_panel(filters) }}
  {% endif %}

  <div class="row">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
          {% if show_card_title|default(false) %}
          <h3 class="h4 mb-0 text-primary">{{ entity_title|default('Items') }}</h3>
          {% else %}
          <div></div> {# Empty div to maintain flex layout #}
          {% endif %}
          {% block table_actions %}{% endblock %}
        </div>

        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <div class="dropdown">
              <button class="btn dropdown-toggle" type="button" id="columnSelectorDropdownToggle" data-bs-toggle="dropdown" data-bs-auto-close="outside">
                <i class="fas fa-table me-2"></i> Columns
              </button>
              <ul class="dropdown-menu" style="min-width: 180px; width: auto;" aria-labelledby="columnSelectorDropdownToggle">
                <li class="px-3 py-2">
                  <div class="d-flex align-items-center">
                    <button class="btn btn-sm btn-outline-primary me-2" id="selectAllColumns">All</button>
                    <button class="btn btn-sm btn-outline-danger" id="clearAllColumns">Clear</button>
                  </div>
                </li>
                <li><hr class="dropdown-divider" /></li>
                <li class="px-2" onclick="event.stopPropagation();">
                  <div class="column-list py-1" id="columnSelectorItems" data-column-name="__all_columns__">
                    <!-- JS will populate this -->
                  </div>
                </li>
              </ul>
            </div>

            <div class="input-group w-25">
              <span class="input-group-text">
                <i class="fas fa-search"></i>
              </span>
              <input type="text" class="form-control" id="globalSearch" placeholder="Search..." aria-label="Search">
            </div>
          </div>

          <div id="table-container"
               class="ag-theme-alpine w-100"
               data-api-url="{{ api_url|default('') }}"
               data-default-sort="{{ default_sort|default('name') }}"
               data-entity-type="{{ entity_name|default('Item') }}"
               data-additional-filters="{{ additional_filters|default({})|tojson|replace('"', '&quot;') }}"
               style="min-height: 420px;">
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{# JavaScript for table functionality #}
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Make column selectors stop propagation to prevent dropdown closure
  document.querySelectorAll('#columnSelectorItems, #selectAllColumns, #clearAllColumns').forEach(element => {
    element.addEventListener('click', function(e) {
      e.stopPropagation();
    });
  });

  // Initialize filter form if present
  const filterForm = document.getElementById('tableFilters');
  if (filterForm) {
    filterForm.addEventListener('submit', function(e) {
      e.preventDefault();

      // Collect filter values
      const filters = {};
      const formData = new FormData(this);

      for (const [key, value] of formData.entries()) {
        if (value) {
          const inputElem = document.querySelector(`[name="${key}"]`);
          const filterType = inputElem.dataset.filterType || 'contains';

          if (!filters[key.replace('_from', '').replace('_to', '')]) {
            filters[key.replace('_from', '').replace('_to', '')] = {};
          }

          if (key.endsWith('_from')) {
            filters[key.replace('_from', '')]['greaterThanOrEqual'] = value;
          } else if (key.endsWith('_to')) {
            filters[key.replace('_to', '')]['lessThanOrEqual'] = value;
          } else {
            filters[key][filterType] = value;
          }
        }
      }

      // Apply filters to table
      if (window.gridApi) {
        window.gridApi.setFilterModel(filters);
      }
    });

    // Clear filters button
    document.getElementById('clearAllFilters')?.addEventListener('click', function() {
      filterForm.reset();
      if (window.gridApi) {
        window.gridApi.setFilterModel(null);
      }
    });
  }

  // Table initialization
  const tableContainer = document.getElementById('table-container');
  if (tableContainer) {
    const apiUrl = tableContainer.dataset.apiUrl;
    const entityType = tableContainer.dataset.entityType;
    const defaultSort = tableContainer.dataset.defaultSort || 'name';
    const additionalFilters = tableContainer.dataset.additionalFilters
      ? JSON.parse(tableContainer.dataset.additionalFilters)
      : {};

    console.log("Initializing table", {
      apiUrl,
      entityType,
      defaultSort,
      additionalFilters
    });

    // Initialize the table (AG Grid setup)
    if (typeof initAgGrid === 'function') {
      initAgGrid(tableContainer, apiUrl, {
        defaultSort,
        additionalFilters,
        entityType
      });
    } else {
      console.error("AG Grid initialization function not found");
    }
  }
});
</script>