{# ------------------------------------------------------------------------------
  File: _table_index.html | Purpose: Partial template for entity table index
  Description:
    - Displays entity listing with AG Grid
    - Includes filtering, column selector, and global search
------------------------------------------------------------------------------ #}

{# Filter panel macro #}
{% macro render_filter_panel(filters) %}
<div class="filter-panel card border-0 shadow-sm mb-4">
  <div class="card-header bg-light d-flex justify-content-between align-items-center py-2"> {# Added bg-light, py-2 #}
    <h5 class="mb-0 fs-6 fw-semibold">Filters</h5> {# Adjusted heading style #}
    <button class="btn btn-sm btn-outline-secondary" id="clearAllFilters" type="button"> {# Added type="button" #}
      <i class="fas fa-times me-1"></i> Clear All
    </button>
  </div>
  <div class="card-body p-3"> {# Adjusted padding #}
    {# Use GET method for filters usually, unless very complex #}
    <form id="tableFilters" class="row g-3" method="GET" action="">
      {% for filter in filters %}
        <div class="col-md-{{ filter.width|default(6) }} col-lg-{{ filter.lg_width|default(filter.width|default(4)) }}"> {# Added responsive col-lg #}
          <label for="filter_{{ filter.field }}" class="form-label fw-medium small mb-1">{{ filter.label }}</label> {# Adjusted label style #}
          {% if filter.type == 'select' %}
            <select class="form-select form-select-sm" id="filter_{{ filter.field }}" name="{{ filter.field }}" data-filter-type="{{ filter.filterType|default('equals') }}"> {# Added form-select-sm #}
              <option value="">-- All --</option>
              {% for option in filter.options %}
                {% if option is mapping %}
                  <option value="{{ option.value }}" {% if request.args.get(filter.field) == option.value|string %}selected{% endif %}>{{ option.label }}</option>
                {% else %}
                  <option value="{{ option }}" {% if request.args.get(filter.field) == option|string %}selected{% endif %}>{{ option }}</option>
                {% endif %}
              {% endfor %}
            </select>
          {% elif filter.type == 'date' %}
            <div class="input-group input-group-sm"> {# Added input-group-sm #}
              {# Use consistent naming for range filters #}
              <input type="date" class="form-control" id="filter_{{ filter.field }}_start" name="{{ filter.field }}_start" data-filter-type="greaterThanOrEqual" value="{{ request.args.get(filter.field + '_start', '') }}">
              <span class="input-group-text">to</span>
              <input type="date" class="form-control" id="filter_{{ filter.field }}_end" name="{{ filter.field }}_end" data-filter-type="lessThanOrEqual" value="{{ request.args.get(filter.field + '_end', '') }}">
            </div>
          {% elif filter.type == 'number' %}
             <div class="input-group input-group-sm"> {# Added input-group-sm #}
               {# Use consistent naming for range filters #}
              <input type="number" class="form-control" id="filter_{{ filter.field }}_min" name="{{ filter.field }}_min" placeholder="Min" data-filter-type="greaterThanOrEqual" value="{{ request.args.get(filter.field + '_min', '') }}">
              <span class="input-group-text">to</span>
              <input type="number" class="form-control" id="filter_{{ filter.field }}_max" name="{{ filter.field }}_max" placeholder="Max" data-filter-type="lessThanOrEqual" value="{{ request.args.get(filter.field + '_max', '') }}">
            </div>
          {% else %}
            {# Default text filter #}
            <input type="{{ filter.type|default('text') }}" class="form-control form-control-sm" id="filter_{{ filter.field }}" name="{{ filter.field }}" placeholder="{{ filter.placeholder|default(filter.label) }}" data-filter-type="{{ filter.filterType|default('contains') }}" value="{{ request.args.get(filter.field, '') }}"> {# Added form-control-sm #}
          {% endif %}
        </div>
      {% endfor %}
      <div class="col-12 mt-3"> {# Adjusted margin #}
        <button type="submit" class="btn btn-sm btn-primary"><i class="fas fa-filter me-1"></i> Apply Filters</button>
        {# Reset button might be better handled by JS clearAllFilters or a link back to the base URL #}
        <a href="{{ request.path }}" class="btn btn-sm btn-outline-secondary"><i class="fas fa-undo me-1"></i> Reset Filters</a>
      </div>
    </form>
  </div>
</div>
{% endmacro %}

{# Main table container #}
<div class="container-fluid mt-3"> {# Added margin-top #}
  <div class="row mb-3"> {# Adjusted margin-bottom #}
    <div class="col-12 d-flex flex-wrap justify-content-between align-items-center"> {# Added flex-wrap #}
      {% if show_heading|default(true) %}
        <h1 class="h3 mb-2 mb-md-0 me-3">{{ entity_title|default('Items') }}</h1> {# Adjusted margins #}
      {% endif %}
      <div class="action-buttons ms-auto"> {# Added ms-auto to push buttons right #}
        {% block action_buttons %}
          {# Check if user has permission if applicable #}
          <a href="{{ url_for(entity_base_route + '.create') }}" class="btn btn-sm btn-primary"> {# Added btn-sm #}
            <i class="fas fa-plus me-1"></i> Add {{ entity_name|default('Item') }}
          </a>
        {% endblock %}
        {% block extra_action_buttons %}{% endblock %} {# Placeholder for more buttons #}
      </div>
    </div>
  </div>

  {# Render filter panel if filters are defined #}
  {% if filters is defined and filters|length > 0 %}
    {{ render_filter_panel(filters) }}
  {% endif %}

  <div class="row">
    <div class="col-12">
      <div class="card border-0 shadow-sm">
        {# Optional card header for table actions like export, column visibility etc. #}
        {% if show_card_header|default(true) %}
        <div class="card-header bg-light py-2 border-bottom d-flex flex-wrap align-items-center"> {# Added styles #}
           {% if show_card_title|default(false) %} {# Optional Title within Card Header #}
             <h5 class="mb-0 me-3 fs-6 fw-semibold">{{ entity_title|default('Items') }} List</h5>
           {% endif %}
           {# Placeholder for table-specific actions like export, column visibility toggle #}
           <div class="ms-auto d-flex gap-2">
              {% block table_actions %}
                {# Example: <button id="exportCsvBtn" class="btn btn-sm btn-outline-secondary"><i class="fas fa-file-csv me-1"></i> Export CSV</button> #}
              {% endblock %}
           </div>
         </div>
        {% endif %}

        <div class="card-body p-0"> {# Removed padding for grid #}
          {# AG Grid Container #}
          <div id="table-container" {# Use a more specific ID if multiple tables exist #}
               class="ag-theme-alpine" {# Removed w-100, handled by AG Grid itself #}
               data-api-url="{{ api_url|default('') }}"
               data-entity-name="{{ entity_name|default('item') }}" {# Pass entity name for context #}
               {# Set height via CSS or JS for better control #}
               style="height: 600px; width: 100%;">
          </div>
        </div>
        {# Optional card footer for pagination info or summary #}
        {# <div class="card-footer bg-light py-2">
             <span id="rowCountInfo"></span>
           </div> #}
      </div>
    </div>
  </div>
</div>

<script type="module">
  // Import paths updated for the new structure
  import log from '{{ url_for('static', filename='js/core/logger.js') }}';
  // Import the correct function name
  import initializeTable from '{{ url_for('static', filename='js/components/table.js') }}';

  // Ensure the DOM is fully loaded before initializing the grid
  if (document.readyState === 'complete' || document.readyState === 'interactive') {
      initializeGrid();
  } else {
      document.addEventListener('DOMContentLoaded', initializeGrid);
  }

  function initializeGrid() {
    const scriptName = '_table_index.html (inline)';
    const functionName = 'initializeGrid';
    try {
      log('info', scriptName, functionName, 'üöÄ DOM ready. Initializing AG Grid table...');
      // Call the correct function name without arguments
      initializeTable()
        .then(() => {
          log('info', scriptName, functionName, '‚úÖ AG Grid initialization completed successfully.');
        })
        .catch(error => {
          log('error', scriptName, functionName, '‚ùå Table initialization failed:', error);
          // Display an error message in the table container
          const container = document.querySelector('#table-container');
          if(container) {
              container.innerHTML = '<div class="alert alert-danger m-3">Could not load table data. Please try again later.</div>';
          }
        });
    } catch (error) {
      log('error', scriptName, functionName, '‚ùå Failed to initialize AG Grid table.', error);
      // Optionally display an error message to the user in the table container
      const container = document.querySelector('#table-container');
      if(container) {
          container.innerHTML = '<div class="alert alert-danger m-3">Could not load table data. Please try again later.</div>';
      }
    }
  }
</script>