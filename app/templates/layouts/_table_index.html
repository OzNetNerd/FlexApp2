{# ------------------------------------------------------------------------------
  File: _table_index.html | Purpose: Partial template for entity table index
  Description:
    - Displays entity listing with AG Grid
    - Includes filtering, column selector, and global search
------------------------------------------------------------------------------ #}

{# Filter panel macro #}
{% macro render_filter_panel(filters) %}
<div class="filter-panel card border-0 shadow-sm mb-4">
  <div class="card-header bg-white d-flex justify-content-between align-items-center">
    <h5 class="mb-0">Filters</h5>
    <button class="btn btn-sm btn-outline-secondary" id="clearAllFilters">
      <i class="fas fa-times me-1"></i> Clear All
    </button>
  </div>
  <div class="card-body">
    <form id="tableFilters" class="row g-3">
      {% for filter in filters %}
        <div class="col-md-{{ filter.width|default(6) }}">
          <label for="filter_{{ filter.field }}" class="form-label">{{ filter.label }}</label>
          {% if filter.type == 'select' %}
            <select class="form-select" id="filter_{{ filter.field }}" name="{{ filter.field }}" data-filter-type="{{ filter.filterType|default('equals') }}">
              <option value="">-- All --</option>
              {% for option in filter.options %}
                {% if option is mapping %}
                  <option value="{{ option.value }}">{{ option.label }}</option>
                {% else %}
                  <option value="{{ option }}">{{ option }}</option>
                {% endif %}
              {% endfor %}
            </select>
          {% elif filter.type == 'date' %}
            <div class="input-group">
              <input type="date" class="form-control" id="filter_{{ filter.field }}_from" name="{{ filter.field }}_from" data-filter-type="greaterThanOrEqual">
              <span class="input-group-text">to</span>
              <input type="date" class="form-control" id="filter_{{ filter.field }}_to" name="{{ filter.field }}_to" data-filter-type="lessThanOrEqual">
            </div>
          {% elif filter.type == 'number' %}
            <div class="input-group">
              <input type="number" class="form-control" id="filter_{{ filter.field }}_from" name="{{ filter.field }}_from" placeholder="Min" data-filter-type="greaterThanOrEqual">
              <span class="input-group-text">to</span>
              <input type="number" class="form-control" id="filter_{{ filter.field }}_to" name="{{ filter.field }}_to" placeholder="Max" data-filter-type="lessThanOrEqual">
            </div>
          {% else %}
            <input type="{{ filter.type|default('text') }}" class="form-control" id="filter_{{ filter.field }}" name="{{ filter.field }}" placeholder="{{ filter.placeholder|default('') }}" data-filter-type="{{ filter.filterType|default('contains') }}">
          {% endif %}
        </div>
      {% endfor %}
      <div class="col-12">
        <button type="submit" class="btn btn-primary"><i class="fas fa-filter me-1"></i> Apply Filters</button>
        <button type="reset" class="btn btn-outline-secondary"><i class="fas fa-undo me-1"></i> Reset</button>
      </div>
    </form>
  </div>
</div>
{% endmacro %}

{# Main table container #}
<div class="container-fluid">
  <div class="row mb-4">
    <div class="col-12 d-flex justify-content-between align-items-center">
      {% if show_heading|default(true) %}
        <h1 class="h3">{{ entity_title|default('Items') }}</h1>
      {% endif %}
      <div class="action-buttons">
        {% block action_buttons %}
          <a href="{{ url_for(entity_base_route + '.create') }}" class="btn btn-primary">
            <i class="fas fa-plus me-1"></i> Add {{ entity_name|default('Item') }}
          </a>
        {% endblock %}
      </div>
    </div>
  </div>

  {% if filters is defined %}
    {{ render_filter_panel(filters) }}
  {% endif %}

  <div class="row">
    <div class="col-12">
      <div class="card border-0 shadow-sm mb-3">
        {% if show_card_title|default(false) %}
          <h3 class="h4 mb-0 text-primary">{{ entity_title|default('Items') }}</h3>
        {% endif %}
        {% block table_actions %}{% endblock %}
      </div>
      <div class="card-body p-0">
        <div id="table-container"
             class="ag-theme-alpine w-100"
             data-api-url="{{ api_url|default('') }}"
             style="min-height:420px;">
        </div>
      </div>
    </div>
  </div>
</div>

{# Inline module loader for AG Grid #}
<script type="module">
  import log from '/static/js/logger.js';
  import initTable from '/static/js/table/tableInit.js';

  document.addEventListener('DOMContentLoaded', () => {
    const scriptName = '_table_index.html';
    const functionName = 'DOMContentLoaded';
    log('info', scriptName, functionName, 'Initializing AG Grid table');
    initTable();
  });
</script>
