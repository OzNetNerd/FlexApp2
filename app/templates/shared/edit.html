<!-- START TEMPLATE: edit.html -->
{# ------------------------------------------------------------------------------
  File: edit.html | Purpose: Renders an edit form for entities
  Structure:
    - Extends: base/entity_page.html
    - Inputs:
        - title     : Page title
        - read_only : false
        - id        : Optional entity ID
        - ui        : List[Tab] structure with sections and TabEntry fields
  Output:
    - A Bootstrap card with tabbed section layout
    - Cancel button (routes to view or index)
    - Form posts back to current route
------------------------------------------------------------------------------ #}

{% extends "base/entity_page.html" %}
{% import "macros/form_fields.html" as macros %}

{% block content -%}
<div class="card border-0 shadow-sm">
  <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
    <h3 class="h4 mb-0 text-primary">
      <i class="fas fa-edit me-2"></i>
      {{ title }}
    </h3>
    <div class="d-flex gap-2">
      {% if id %}
        <a href="{{ url_for(request.endpoint.rsplit('.', 1)[0] + '.view', item_id=id) }}" class="btn btn-secondary bg-opacity-75 fw-semibold text-white">
          <i class="fas fa-times me-1"></i> Cancel
        </a>
      {% else %}
        <a href="{{ url_for(request.endpoint.rsplit('.', 1)[0] + '.index') }}" class="btn btn-secondary bg-opacity-75 fw-semibold text-white">
          <i class="fas fa-times me-1"></i> Cancel
        </a>
      {% endif %}
    </div>
  </div>

  <div class="card-body">
    <form method="POST">
      {% include 'pages/form/_pills_nav_content.html' %}
      {% include 'pages/form/_autocomplete.html' %}
      {% include 'pages/form/_footer.html' %}
    </form>
  </div>
</div>

<!-- Initialize Autocomplete Fields -->
<script type="module">
  import { initAutoCompleteFields } from "/static/js/autoComplete.js";
  // Since this script is at the end of the body, the DOM is ready.
  initAutoCompleteFields();
</script>

<!-- Logging for Edit Page Context -->
<script type="module">
  import log from "{{ url_for('static', filename='js/logger.js') }}";

  const editContext = {
    mode: {{ "'edit'" if id else "'create'" }},
    entityId: {{ id | tojson }},
    title: {{ title | tojson }},
    cancelDestination: {{ "'view'" if id else "'index'" }},
    tabCount: {{ ui | length }},
    structure: [
      {% for tab in ui %}
        {
          tab: {{ tab.tab_name | tojson }},
          sections: {{ tab.sections | map(attribute='section_name') | list | tojson | safe }},
          fieldCount: {{ tab.sections | map(attribute='entries') | map('length') | sum }}
        }{% if not loop.last %},{% endif %}
      {% endfor %}
    ]
  };

  log("info", "edit.html", "render", "üìù Edit form initialized", editContext);
</script>
{%- endblock %}
<!-- END TEMPLATE: edit.html -->