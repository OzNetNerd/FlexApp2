{% extends "layouts/base.html" %}

{% import 'macros/render_form_fields.html' as field_macros with context %}
{% import 'macros/tabs.html'            as tab_macros   with context %}
{% import 'macros/entity_macros.html'   as entity_macros with context %}
{% import 'macros/render_notes.html'    as notes_macros  with context %}

{% block content %}
<div class="card border-0 shadow-sm" style="overflow: visible !important;">
  <!-- Card Header -->
  <div class="card-header bg-white py-3 pb-0" style="border: none;">
    <div class="d-flex justify-content-between align-items-center">
      <!-- Header Left - Heading -->
      <div class="d-flex align-items-center">
        <h3 class="h4 mb-0 text-primary me-3">
          {% if read_only %}
            <i class="fas fa-eye me-2"></i>
            View Company: <span class="text-info">{{ entity.name }}</span>
          {% else %}
            <i class="fas fa-edit me-2"></i>
            Edit Company: <span class="text-info">{{ entity.name }}</span>
          {% endif %}
        </h3>
      </div>
      <!-- Header Right - Action Buttons -->
      <div class="d-flex gap-2">
        <div class="d-flex justify-content-end align-items-center gap-2">
          {% if read_only %}
            <a href="{{ url_for('companies_bp.new') }}" class="btn btn-primary fw-bold">
              <i class="fas fa-plus me-1"></i> Add
            </a>
            {% if entity.id %}
              <a href="{{ url_for('companies_bp.edit', entity_id=entity.id) }}"
                 class="btn btn-warning text-dark fw-bold">
                <i class="fas fa-edit me-1"></i> Edit
              </a>
              <button type="button" id="delete-button" class="btn btn-danger">
                <i class="fas fa-trash me-1"></i> Delete
              </button>
            {% endif %}
            <a href="{{ url_for('companies_bp.index') }}" class="btn btn-secondary">
              <i class="fas fa-arrow-left me-1"></i> Back
            </a>
          {% else %}
            <!-- your edit‐mode buttons… -->
          {% endif %}
        </div>
      </div>
    </div>
    <!-- Tabs Navigation -->
    <div class="mt-3">
      <ul class="nav nav-tabs mb-3" id="formTabs" role="tablist"
          data-tab-names='{{ tabs | map(attribute="tab_name") | list | tojson }}'>
        {% for tab in tabs %}
          <li class="nav-item" role="presentation">
            <button class="nav-link {% if tab.active %}active{% endif %}"
                    id="tab-{{ tab.tab_name|lower|replace(' ', '-') }}-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#tab-{{ tab.tab_name|lower|replace(' ', '-') }}"
                    type="button" role="tab"
                    aria-controls="tab-{{ tab.tab_name|lower|replace(' ', '-') }}"
                    aria-selected="{{ 'true' if tab.active else 'false' }}">
              {{ tab.tab_name }}
            </button>
          </li>
        {% endfor %}
      </ul>
    </div>
  </div>

  <!-- Card Body -->
  <div class="card-body pt-0 pb-0" style="overflow: visible !important;">
    <form method="post" id="main-form">
      <div class="tab-content" id="formTabsContent">
        {% for tab in tabs %}
          {% if tab.tab_name == 'Notes' %}
            <div class="tab-pane fade {% if tab.active %}show active{% endif %}"
                id="tab-notes" role="tabpanel"
                aria-labelledby="tab-notes-tab">
              <div class="section-card card shadow-sm border-0 mb-4">
                <div class="section-header">
                  <h5 class="section-heading">Notes</h5>
                </div>
                <div class="section-body">
                  <div class="row g-3">
                    <!-- Search bar -->
                    <div class="col-12 mb-3">
                      <div class="input-group">
                        <span class="input-group-text border-0 bg-transparent">
                          <i class="fas fa-search"></i>
                        </span>
                        <input type="search"
                              id="noteSearchInput"
                              class="form-control border-0 shadow-none"
                              placeholder="Search notes..."
                              aria-label="Search notes">
                      </div>
                    </div>

                    <!-- hidden config for JS -->
                    <div id="notesData"
                        data-notable-type="Company"
                        data-notable-id="{{ entity.id }}"
                        data-user-id="{{ current_user.id }}"
                        data-username="{{ current_user.username }}">
                    </div>

                    <!-- Filter dropdown -->
                    <div class="col-12">
                      <div class="d-flex justify-content-start align-items-center mb-3">
                        <select id="noteFilterSelect" class="form-select form-select-sm w-auto">
                          <option value="7">Last 7 days</option>
                          <option value="30">Last 30 days</option>
                          <option value="0" selected>All notes</option>
                          <option value="custom">Custom range…</option>
                        </select>
                      </div>
                    </div>

                    <!-- loading spinner -->
                    <div class="col-12">
                      <div id="notesLoading" class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                          <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">Loading notes…</p>
                      </div>
                    </div>

                    <!-- actual notes list -->
                    <div class="col-12">
                      <div id="notesList" class="notes-list mb-4">
                        <!-- populated by JS -->
                      </div>
                    </div>

                    <!-- new note form -->
                    <div class="col-12">
                      <form id="newNoteForm" class="mt-4">
                        <div class="mb-3">
                          <label for="content" class="form-label">Add a note</label>
                          <textarea id="content" name="content"
                                   class="form-control" rows="3"
                                   placeholder="Enter your note here…"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary">
                          <i class="fas fa-plus me-1"></i> Add Note
                        </button>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          {% endif %}

          {% if tab.tab_name == 'About' %}
            <div class="tab-pane fade {% if tab.active %}show active{% endif %}"
                id="tab-about" role="tabpanel"
                aria-labelledby="tab-about-tab">
              <div class="section-card card shadow-sm border-0 mb-4">
                <div class="section-header">
                  <h5 class="section-heading">About</h5>
                </div>
                <div class="section-body">
                  <div class="row g-3">
                    <div class="col-md-6 mb-3">
                      <div class="p-3 border rounded">
                        <strong>Company Name</strong>
                        <p>{{ entity.name }}</p>
                      </div>
                    </div>
                    <div class="col-md-6 mb-3">
                      <div class="p-3 border rounded">
                        <strong>Description</strong>
                        <p>{{ entity.description }}</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          {% endif %}

          {% if tab.tab_name == 'System Info' and read_only %}
            <div class="tab-pane fade {% if tab.active %}show active{% endif %}"
                id="tab-system-info" role="tabpanel"
                aria-labelledby="tab-system-info-tab">
              <div class="section-card card shadow-sm border-0 mb-4">
                <div class="section-header">
                  <h5 class="section-heading">System Info</h5>
                </div>
                <div class="section-body">
                  <div class="row g-3">
                    <!-- render created_at / updated_at via Jinja -->
                    {{ field_macros.render_field({
                      "entry_name": 'created_at',
                      "label": 'Created',
                      "type": 'text',
                      "value": entity.created_at,
                      "required": false,
                      "options": []
                    }, read_only=true) }}
                    {{ field_macros.render_field({
                      "entry_name": 'updated_at',
                      "label": 'Last Updated',
                      "type": 'text',
                      "value": entity.updated_at,
                      "required": false,
                      "options": []
                    }, read_only=true) }}
                  </div>
                </div>
              </div>
            </div>
          {% endif %}
        {% endfor %}
      </div>
    </form>
  </div>
</div>

<script type="module" src="/static/js/pages/notesSection.js"></script>
{% endblock %}